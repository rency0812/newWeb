/*
	ES.ExSunMap 2.4.0, a js library for ExSunMap lbs instance.
	(c) 2016-2018, liulin
	武汉依迅
	http://www.ExSunMap.cn/
*/

!function(t,e,i){i.ExSunMap={},i.ExSunMap.Version="0.2.4",i.ExSunMap={liveLineConfig:{opacity:1,color:"blue",weight:3},oLiveCircleMarkerConfig:{fill:!0,fillColor:"#fff",radius:3,weight:1,opacity:1,fillOpacity:1},onEvent:function(t,n,o,a){var s=e.getElementsByClassName(t);if(s&&!(s.length<=0))for(var r=0;r<s.length;r++)i.DomEvent.on(s[r],n,o,a)},hide:function(t){t.style.display="none"},show:function(t){t.style.display="block"},findLayer:function(t,e){if(!t||t.getLayers().length<=0)return null;var i=t.getLayers();for(var n in i)if(i[n].cId===e)return i[n];return null},arrayIndex:function(t,e,i){var n=-1;if(!t||t.length<=0)return n;if(!i||!e)return n;if(!e.hasOwnProperty(i))return n;if(!t[0].hasOwnProperty(i))return n;for(var o=0;o<t.length;o++)if(t[o][i]===e[i]){n=o;break}return n},initPopHtml:function(t){return t.online="通信中断",t.speedStatus="停止",t.gpsStatus="未定位",t.hasOwnProperty("vehTy")||(t.vehTy=""),t.hasOwnProperty("pos")||(t.pos=""),1===t.sta||2===t.sta||3===t.sta||4===t.sta?t.online="在线":t.online="通信中断",1===t.sta?t.speedStatus="行驶":t.online="停止",4===t.sta||5===t.sta?t.gpsStatus="未定位":t.gpsStatus="已定位",t.dura=i.ExSunMap.getTimeBySecond(t.dayHour),i.Util.template(i.ExSunMap.popHtml,t)},getTimeBySecond:function(t){if(t>86400){return(t/86400).toFixed(2)+"天"}if(t>3600&&t<=86400){var e=t/3600;return e.toFixed(2)+"时"}var e=t/60;return e.toFixed(2)+"分"},initPopEven:function(t,e){t&&t.on("contentupdate",function(){i.ExSunMap.onEvent("veh-detail","click",function(){e.$emit("detail",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-history","click",function(){e.$emit("history",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-track","click",function(t){t.currentTarget&&"跟踪"===t.currentTarget.innerText?(e.$emit("track",this.oGpsInfo),e.$emit("lst-track",this.oGpsInfo),t.currentTarget.innerText="取消跟踪"):(e.$emit("untrack",this.oGpsInfo),e.$emit("lst-untrack",this.oGpsInfo),t.currentTarget.innerText="跟踪")},this),i.ExSunMap.onEvent("veh-attend","click",function(t){t.currentTarget&&"关注"===t.currentTarget.innerText?(e.$emit("veh-attend",this.oGpsInfo),t.currentTarget.innerHTML='<a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 取消关注 </a>'):(e.$emit("veh-unattend",this.oGpsInfo),t.currentTarget.innerHTML='<a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 关注 </a>')},this),i.ExSunMap.onEvent("veh-monitor","click",function(){e.$emit("monitor",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-video","click",function(){e.$emit("video",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-call-name","click",function(){e.$emit("send-call-name",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-camera","click",function(){e.$emit("send-camera",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-text","click",function(){e.$emit("send-text",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-monitor","click",function(){e.$emit("send-monitor",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-config","click",function(){e.$emit("send-config",this.oGpsInfo)},this)},t)},popHtml:'       <div class="ex-maptip-wtm-content">   <div class="ex-content-info-box">               <h3>{vehNo} <span>{time}</span></h3>       <div class="ex-content-info-car ec-u-sm-6">           <ul>                        <li><strong>设备号：</strong><span>{devNo}</span></li>                       <li><strong>车辆颜色：</strong><span>{vehPCor}</span></li>                       <li><strong>车辆类型：</strong><span>{vehTy}</span></li>                       <li><strong>车辆户籍：</strong><span>{deptName}</span></li>                       <li><strong>最后速度：</strong><span>{speed} (Km/h)</span></li>           </ul>       </div>       <div class="ex-content-info-state ec-u-sm-6">           <ul>                       <li><strong>在线状态：</strong><span>{online}</span></li>                       <li><strong>行驶状态：</strong><span>{speedStatus} </span></li>                       <li><strong>定位状态：</strong><span>{gpsStatus}</span></li>                       <li><strong>今日时长：</strong><span>{dura} </span></li>                       <li><strong>今日里程：</strong><span>{dayMile} Km</span></li>                       <li><strong>总里程：</strong><span>{sumMile} Km</span></li>                   </ul>           </div>           </div>           <div class="ex-maptip-wtm-tool">               <ul class="tool-btn ec-avg-sm-3 ec-u-sm-6">                   <li><strong>最后位置：</strong><span>{pos}</span></li>               </ul>           </div>           <div class="ex-maptip-wtm-tool">           <ul class="tool-btn ec-avg-sm-3 ec-u-sm-6">               <li class="veh-detail"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-truck"> 详情 </a></li>               <li class="veh-history"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 轨迹 </a></li>                   <li class="veh-track"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> {trackBtn} </a></li>                   <li class="veh-attend"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 关注 </a></li>                   <li class="veh-monitor"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 监控 </a></li>                   <li class="veh-send">                       <a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 指令下发 </a>                       <ul class="veh-send-btn" >                           <li class="send-call-name"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 点名 </a></li>                           <li class="send-camera"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 拍照 </a></li>                           <li class="send-text"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 文本 </a></li>                           <li class="send-monitor"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 监听 </a></li>                           <li class="send-config"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 参数设置 </a></li>                       </ul>                   </li>                   <li class="veh-video"><a href="javascript:void(0)" class="ec-btn ec-radius ec-icon-exchange"> 视频 </a></li>           </ul>       </div>       </div>'},i.getData=function(t,e,i,n){var o=new XMLHttpRequest;o.open("POST",e,!0),o.setRequestHeader("Content-type","application/json"),o.onreadystatechange=function(){4!=o.readyState||200!=o.status&&304!=o.status||i.call(n,o.responseText)},o.send(t)},i.ExSunMap.Tooltip=i.Class.extend({initialize:function(t){this._map=t,this._popupPane=t._panes.popupPane;var e=i.DomUtil.create("div","leaflet-draw-tooltip",this._popupPane);this._container=e,this._singleLineLabel=!1,this._map.on("mouseout",this._onMouseOut,this)},dispose:function(){this._map.off("mouseout",this._onMouseOut,this),this._container&&(this._popupPane.removeChild(this._container),this._container=null)},updateContent:function(t){return this._container?(t.subtext=t.subtext||"",0!==t.subtext.length||this._singleLineLabel?t.subtext.length>0&&this._singleLineLabel&&(i.DomUtil.removeClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!1):(i.DomUtil.addClass(this._container,"leaflet-draw-tooltip-single"),this._singleLineLabel=!0),this._container.innerHTML=(t.subtext.length>0?'<span class="leaflet-draw-tooltip-subtext">'+t.subtext+"</span><br />":"")+"<span>"+t.text+"</span>",this):this},updatePosition:function(t){var e=this._map.latLngToLayerPoint(t),n=this._container;return this._container&&(n.style.visibility="inherit",i.DomUtil.setPosition(n,e)),this},showAsError:function(){return this._container&&i.DomUtil.addClass(this._container,"leaflet-error-draw-tooltip"),this},removeError:function(){return this._container&&i.DomUtil.removeClass(this._container,"leaflet-error-draw-tooltip"),this},_onMouseOut:function(){this._container&&(this._container.style.visibility="hidden")}}),i.Map.mergeOptions({touchExtend:!0}),i.Map.TouchExtend=i.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane},addHooks:function(){i.DomEvent.on(this._container,"touchstart",this._onTouchStart,this),i.DomEvent.on(this._container,"touchend",this._onTouchEnd,this),i.DomEvent.on(this._container,"touchmove",this._onTouchMove,this),this._detectIE()?(i.DomEvent.on(this._container,"MSPointerDown",this._onTouchStart,this),i.DomEvent.on(this._container,"MSPointerUp",this._onTouchEnd,this),i.DomEvent.on(this._container,"MSPointerMove",this._onTouchMove,this),i.DomEvent.on(this._container,"MSPointerCancel",this._onTouchCancel,this)):(i.DomEvent.on(this._container,"touchcancel",this._onTouchCancel,this),i.DomEvent.on(this._container,"touchleave",this._onTouchLeave,this))},removeHooks:function(){i.DomEvent.off(this._container,"touchstart",this._onTouchStart),i.DomEvent.off(this._container,"touchend",this._onTouchEnd),i.DomEvent.off(this._container,"touchmove",this._onTouchMove),this._detectIE()?(i.DomEvent.off(this._container,"MSPointerDowm",this._onTouchStart),i.DomEvent.off(this._container,"MSPointerUp",this._onTouchEnd),i.DomEvent.off(this._container,"MSPointerMove",this._onTouchMove),i.DomEvent.off(this._container,"MSPointerCancel",this._onTouchCancel)):(i.DomEvent.off(this._container,"touchcancel",this._onTouchCancel),i.DomEvent.off(this._container,"touchleave",this._onTouchLeave))},_touchEvent:function(t,e){var i={};if(void 0!==t.touches){if(!t.touches.length)return;i=t.touches[0]}else{if("touch"!==t.pointerType)return;if(i=t,!this._filterClick(t))return}var n=this._map.mouseEventToContainerPoint(i),o=this._map.mouseEventToLayerPoint(i),a=this._map.layerPointToLatLng(o);this._map.fire(e,{latlng:a,layerPoint:o,containerPoint:n,pageX:i.pageX,pageY:i.pageY,originalEvent:t})},_filterClick:function(t){var e=t.timeStamp||t.originalEvent.timeStamp,n=i.DomEvent._lastClick&&e-i.DomEvent._lastClick;return n&&n>100&&n<500||t.target._simulatedClick&&!t._simulated?(i.DomEvent.stop(t),!1):(i.DomEvent._lastClick=e,!0)},_onTouchStart:function(t){if(this._map._loaded){this._touchEvent(t,"touchstart")}},_onTouchEnd:function(t){if(this._map._loaded){this._touchEvent(t,"touchend")}},_onTouchCancel:function(t){if(this._map._loaded){var e="touchcancel";this._detectIE()&&(e="pointercancel"),this._touchEvent(t,e)}},_onTouchLeave:function(t){if(this._map._loaded){this._touchEvent(t,"touchleave")}},_onTouchMove:function(t){if(this._map._loaded){this._touchEvent(t,"touchmove")}},_detectIE:function(){var e=t.navigator.userAgent,i=e.indexOf("MSIE ");if(i>0)return parseInt(e.substring(i+5,e.indexOf(".",i)),10);if(e.indexOf("Trident/")>0){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}var o=e.indexOf("Edge/");return o>0&&parseInt(e.substring(o+5,e.indexOf(".",o)),10)}}),i.Map.addInitHook("addHandler","touchExtend",i.Map.TouchExtend),i.Marker.Touch=i.Marker.extend({_initInteraction:function(){return this.addInteractiveTarget?i.Marker.prototype._initInteraction.apply(this):this._initInteractionLegacy()},_initInteractionLegacy:function(){if(this.options.clickable){var t=this._icon,e=["dblclick","mousedown","mouseover","mouseout","contextmenu","touchstart","touchend","touchmove"];this._detectIE?e.concat(["MSPointerDown","MSPointerUp","MSPointerMove","MSPointerCancel"]):e.concat(["touchcancel"]),i.DomUtil.addClass(t,"leaflet-clickable"),i.DomEvent.on(t,"click",this._onMouseClick,this),i.DomEvent.on(t,"keypress",this._onKeyPress,this);for(var n=0;n<e.length;n++)i.DomEvent.on(t,e[n],this._fireMouseEvent,this);i.Handler.MarkerDrag&&(this.dragging=new i.Handler.MarkerDrag(this),this.options.draggable&&this.dragging.enable())}},_detectIE:function(){var e=t.navigator.userAgent,i=e.indexOf("MSIE ");if(i>0)return parseInt(e.substring(i+5,e.indexOf(".",i)),10);if(e.indexOf("Trident/")>0){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}var o=e.indexOf("Edge/");return o>0&&parseInt(e.substring(o+5,e.indexOf(".",o)),10)}}),i.LatLngUtil={cloneLatLngs:function(t){for(var e=[],n=0,o=t.length;n<o;n++)Array.isArray(t[n])?e.push(i.LatLngUtil.cloneLatLngs(t[n])):e.push(this.cloneLatLng(t[n]));return e},cloneLatLng:function(t){return i.latLng(t.lat,t.lng)}},i.GeometryUtil={geodesicArea:function(t){var e,i,n=t.length,o=0,a=Math.PI/180;if(n>2){for(var s=0;s<n;s++)e=t[s],i=t[(s+1)%n],o+=(i.lng-e.lng)*a*(2+Math.sin(e.lat*a)+Math.sin(i.lat*a));o=6378137*o*6378137/2}return Math.abs(o)},readableArea:function(t,e){var i;return e?i=t>=1e4?(1e-4*t).toFixed(2)+" ha":t.toFixed(2)+" m&sup2;":(t/=.836127,i=t>=3097600?(t/3097600).toFixed(2)+" mi&sup2;":t>=4840?(t/4840).toFixed(2)+" acres":Math.ceil(t)+" yd&sup2;"),i},readableDistance:function(t,e,i,n){var o;switch("string"==typeof e?e:i?"feet":n?"nauticalMile":e?"metric":"yards"){case"metric":o=t>1e3?(t/1e3).toFixed(2)+" km":Math.ceil(t)+" m";break;case"feet":t*=3.28083,o=Math.ceil(t)+" ft";break;case"nauticalMile":t*=.53996,o=(t/1e3).toFixed(2)+" nm";break;case"yards":default:t*=1.09361,o=t>1760?(t/1760).toFixed(2)+" miles":Math.ceil(t)+" yd"}return o},geodesicAreaEx:function(t){var e,i,n=t.length,o=0,a=Math.PI/180;if(n>2){for(var s=0;s<n;s++)e=t[s],i=t[(s+1)%n],o+=(i.lng-e.lng)*a*(2+Math.sin(e.lat*a)+Math.sin(i.lat*a));o=6378137*o*6378137/2}return Math.abs(o)},readableAreaEx:function(t,e){var i;return e?i=t>=1e4?(1e-4*t).toFixed(2)+" 平方公顷":t.toFixed(2)+" 平方米":(t/=.836127,i=t>=3097600?(t/3097600).toFixed(2)+" mi&sup2;":t>=4840?(t/4840).toFixed(2)+" acres":Math.ceil(t)+" yd&sup2;"),i},readableDistanceEx:function(t,e,i){var n;if(e)n=t>1e3?(t/1e3).toFixed(2)+" 千米":Math.ceil(t)+" 米";else if((t*=1.09361)>1760)n=(t/1760).toFixed(2)+" miles";else{var o=" yd";i&&(t*=3,o=" ft"),n=Math.ceil(t)+o}return n},readableDistance:function(t,e){var i,n="imperial"!==e;return n?i=t>1e3?(t/1e3).toFixed(2)+" km":Math.ceil(t)+" m":(t*=1.09361,i=t>1760?(t/1760).toFixed(2)+" miles":Math.ceil(t)+" yd"),i}},i.Util.extend(i.LineUtil,{segmentsIntersect:function(t,e,i,n){return this._checkCounterclockwise(t,i,n)!==this._checkCounterclockwise(e,i,n)&&this._checkCounterclockwise(t,e,i)!==this._checkCounterclockwise(t,e,n)},_checkCounterclockwise:function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)}}),i.Polyline.include({intersects:function(){var t,e,i,n=this._getProjectedPoints(),o=n?n.length:0;if(this._tooFewPointsForIntersection())return!1;for(t=o-1;t>=3;t--)if(e=n[t-1],i=n[t],this._lineSegmentsIntersectsRange(e,i,t-2))return!0;return!1},newLatLngIntersects:function(t,e){return!!this._map&&this.newPointIntersects(this._map.latLngToLayerPoint(t),e)},newPointIntersects:function(t,e){var i=this._getProjectedPoints(),n=i?i.length:0,o=i?i[n-1]:null,a=n-2;return!this._tooFewPointsForIntersection(1)&&this._lineSegmentsIntersectsRange(o,t,a,e?1:0)},_tooFewPointsForIntersection:function(t){var e=this._getProjectedPoints(),i=e?e.length:0;return i+=t||0,!e||i<=3},_lineSegmentsIntersectsRange:function(t,e,n,o){var a,s,r=this._getProjectedPoints();o=o||0;for(var h=n;h>o;h--)if(a=r[h-1],s=r[h],i.LineUtil.segmentsIntersect(t,e,a,s))return!0;return!1},_getProjectedPoints:function(){if(!this._defaultShape)return this._originalPoints;for(var t=[],e=this._defaultShape(),i=0;i<e.length;i++)t.push(this._map.latLngToLayerPoint(e[i]));return t}}),i.Polygon.include({intersects:function(){var t,e,n,o,a=this._getProjectedPoints();return!this._tooFewPointsForIntersection()&&(!!i.Polyline.prototype.intersects.call(this)||(t=a.length,e=a[0],n=a[t-1],o=t-2,this._lineSegmentsIntersectsRange(n,e,o,1)))}}),i.ExSunMap.Measure={},i.ExSunMap.Measure.version="2.4.0",i.ExSunMap.Measure.Msg={TipMarker:{setText:{beginText:"开始  "},createIcon:{closeText:"&times;"},addTotalPenal:{total:" 总共 "},setSubTotalDistTag:{total:" 共 "}},Dist:{_getTooltipText:{start:"点击开始测量距离.",cont:"点击继续测量距离.",end:"双击或者点击最后一个点结束测量."}},Area:{_getTooltipText:{start:"点击开始测量面积.",cont:"点击继续测量面积.",end:"双击或者点击第一个点结束测量."}},error:"<strong>错误:</strong> 线段不能相交!"},i.ExSunMap.Measure.DistMgr=i.Handler.extend({options:{},initialize:function(t,e){this._map=t,i.setOptions(this,e),this.aoMeasureHandker=[]},addHooks:function(){var t=i.ExSunMap.Measure.dist(this._map,this,this.options);this.oLastDist=t,this.aoMeasureHandker.push(t),t.createDist()},removeHooks:function(){this.oLastDist.removeDist()}}),i.ExSunMap.Measure.distMgr=function(t,e){return new i.ExSunMap.Measure.DistMgr(t,e)},i.ExSunMap.Measure.Dist=i.Class.extend({includes:i.Mixin.Events,statics:{TYPE:"DIST"},Poly:i.Polyline,options:{allowIntersection:!0,repeatMode:!1,drawError:{color:"#b00b00",timeout:2500},touchIcon:new i.DivIcon({iconSize:new i.Point(20,20),className:"leaflet-div-icon leaflet-editing-icon leaflet-touch-icon"}),guidelineDistance:20,maxGuideLineLength:4e3,shapeOptions:{stroke:!0,color:"#f06eaa",weight:2,opacity:1,fill:!1,clickable:!0},metric:!0,feet:!0,showLength:!0,bIsTotalDist:!0},initialize:function(t,e,n){i.Browser.touch&&(this.options.icon=this.options.touchIcon),this._oParent=e,this.options.drawError.message=i.ExSunMap.Measure.Msg.error,n&&n.drawError&&(n.drawError=i.Util.extend({},this.options.drawError,n.drawError)),this.type=i.ExSunMap.Measure.Dist.TYPE,this._map=t,this._container=t._container,this._overlayPane=t._panes.overlayPane,this._popupPane=t._panes.popupPane,n&&n.shapeOptions&&(n.shapeOptions=i.Util.extend({},this.options.shapeOptions,n.shapeOptions)),this._oLayerGroup=i.featureGroup().addTo(t),i.setOptions(this,n)},createDist:function(){this._map&&(i.DomUtil.disableTextSelection(),this._container.focus(),this._tooltip=new i.ExSunMap.Tooltip(this._map),i.DomEvent.on(this._container,"keyup",this._cancelDrawing,this),this._oMarkerMgr=new i.ExSunMap.Measure.MarkerMgr(this._map,this),this._oTipMarkerMgr=new i.ExSunMap.Measure.TipMarkerMgr(this._map,this,{metric:this.options.metric}),this._poly=new i.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this.initEvent())},initEvent:function(){this._mouseMarker||(this._mouseMarker=i.marker(this._map.getCenter(),{icon:i.divIcon({className:"leaflet-mouse-marker",iconAnchor:[20,20],iconSize:[40,40]}),opacity:0,zIndexOffset:this.options.zIndexOffset})),i.Browser.touch||this._map.on("mouseup",this._onMouseUp,this),this._mouseMarker.on("mousedown",this._onMouseDown,this).on("mouseout",this._onMouseOut,this).on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).addTo(this._map),this._map.on("mouseup",this._onMouseUp,this).on("mousemove",this._onMouseMove,this).on("zoomlevelschange",this._onZoomEnd,this).on("zoomend",this._onZoomEnd,this)},removeDist:function(){i.DomUtil.enableTextSelection(),this._tooltip.dispose(),this._tooltip=null,i.DomEvent.off(this._container,"keyup",this._cancelDrawing,this),this._clearHideErrorTimeout(),this._oMarkerMgr.cleanUpShape(),this._map.removeLayer(this._poly),delete this._poly,this._mouseMarker.off("mousedown",this._onMouseDown,this).off("mouseout",this._onMouseOut,this).off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this),this._map.removeLayer(this._mouseMarker),delete this._mouseMarker,this._clearGuides(),this._map.off("mouseup",this._onMouseUp,this).off("mousemove",this._onMouseMove,this).off("zoomlevelschange",this._onZoomEnd,this).off("zoomend",this._onZoomEnd,this)},deleteLastVertex:function(){if(!(this._markers.length<=1)){var t=this._markers.pop(),e=this._poly,i=this._poly.spliceLatLngs(e.getLatLngs().length-1,1)[0];this._markerGroup.removeLayer(t),e.getLatLngs().length<2&&this._map.removeLayer(e),this._vertexChanged(i,!1)}},addVertex:function(t){if(this._oMarkerMgr.getLen()>0&&!this.options.allowIntersection&&this._poly.newLatLngIntersects(t))return void this._showErrorTooltip();this._errorShown&&this._hideErrorTooltip();var e=this._oMarkerMgr.createMarker(t);this._oTipMarkerMgr.createMarker(t,e,{className:"rule_text_box",iconAnchor:[-10,20]}),this._poly.addLatLng(t),2===this._poly.getLatLngs().length&&this._map.addLayer(this._poly),this._vertexChanged(t,!0)},completeShape:function(){this._markers.length<=1||(this.removeDist(),this.options.repeatMode&&this._oParent.enable())},deleteHandler:function(t){if(this._oMarkerMgr&&!(this._oMarkerMgr.getLen()<=0)){this._oMarkerMgr.removeMarker(t);var e=this._oMarkerMgr.getPointMarkers();this._oRtnPoly&&this._oRtnPoly.setLatLngs(e)}},clearData:function(){!this._oMarkerMgr||this._oMarkerMgr.getLen()<=0||(this._oMarkerMgr.clearData(),this._oRtnPoly&&this._oRtnPoly.setLatLngs([]))},_finishShape:function(){var t=this._poly._defaultShape?this._poly._defaultShape():this._poly.getLatLngs(),e=this._poly.newLatLngIntersects(t[t.length-1]);if(!this.options.allowIntersection&&e||!this._shapeIsValid())return void this._showErrorTooltip();this._oTipMarkerMgr.addCloseBtn(),this._oRtnPoly=new this.Poly(this._poly.getLatLngs(),this.options.shapeOptions),this._oRtnPoly.addTo(this._oLayerGroup),this._oParent.disable(),this.options.bIsTotalDist&&this._oTipMarkerMgr.addTotalDist(),this.options.repeatMode&&this.enable()},_shapeIsValid:function(){return!0},_onZoomEnd:function(){null!==this._markers&&this._updateGuide()},_onMouseMove:function(t){var e=this._map.mouseEventToLayerPoint(t.originalEvent),n=this._map.layerPointToLatLng(e);this._currentLatLng=n,this._updateTooltip(n),this._updateGuide(e),this._mouseMarker.setLatLng(n),i.DomEvent.preventDefault(t.originalEvent)},_vertexChanged:function(){this._map.fire("draw:drawvertex",{layers:this._markerGroup}),this._oMarkerMgr.updateFinishHandler(),this._clearGuides(),this._updateTooltip()},_onMouseDown:function(t){var e=t.originalEvent;this._mouseDownOrigin=i.point(e.clientX,e.clientY)},_onMouseUp:function(e){if(this._mouseDownOrigin){var n=i.point(e.originalEvent.clientX,e.originalEvent.clientY).distanceTo(this._mouseDownOrigin);Math.abs(n)<9*(t.devicePixelRatio||1)&&this.addVertex(e.latlng)}this._mouseDownOrigin=null},_onTouch:function(t){i.Browser.touch&&(this._onMouseDown(t),this._onMouseUp(t))},_onMouseOut:function(){this._tooltip&&this._tooltip._onMouseOut.call(this._tooltip)},_createMarker:function(t){var e=new i.Marker(t,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset});return this._markerGroup.addLayer(e),e},_updateGuide:function(t){(this._oMarkerMgr?this._oMarkerMgr.getLen():0)>0&&(t=t||this._map.latLngToLayerPoint(this._currentLatLng),this._clearGuides(),this._drawGuide(this._map.latLngToLayerPoint(this._oMarkerMgr.getLastGeoPos()),t))},_updateTooltip:function(t){var e=this._getTooltipText();t&&this._tooltip.updatePosition(t),this._errorShown||this._tooltip.updateContent(e)},_drawGuide:function(t,e){var n,o,a,s=Math.floor(Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))),r=this.options.guidelineDistance,h=this.options.maxGuideLineLength,l=s>h?s-h:r;for(this._guidesContainer||(this._guidesContainer=i.DomUtil.create("div","leaflet-draw-guides",this._overlayPane));l<s;l+=this.options.guidelineDistance)n=l/s,o={x:Math.floor(t.x*(1-n)+n*e.x),y:Math.floor(t.y*(1-n)+n*e.y)},a=i.DomUtil.create("div","leaflet-draw-guide-dash",this._guidesContainer),a.style.backgroundColor=this._errorShown?this.options.drawError.color:this.options.shapeOptions.color,i.DomUtil.setPosition(a,o)},_updateGuideColor:function(t){if(this._guidesContainer)for(var e=0,i=this._guidesContainer.childNodes.length;e<i;e++)this._guidesContainer.childNodes[e].style.backgroundColor=t},_clearGuides:function(){if(this._guidesContainer)for(;this._guidesContainer.firstChild;)this._guidesContainer.removeChild(this._guidesContainer.firstChild)},_getTooltipText:function(){var t,e,n=this.options.showLength,o=this._oMarkerMgr.getLen();return 0===o?t={text:i.ExSunMap.Measure.Msg.Dist._getTooltipText.start}:(e=n?this._getMeasurementString():"",t=1===o?{text:i.ExSunMap.Measure.Msg.Dist._getTooltipText.cont,subtext:e}:{text:i.ExSunMap.Measure.Msg.Dist._getTooltipText.end,subtext:e}),t},_getMeasurementString:function(){var t,e=this._currentLatLng,n=this._oMarkerMgr.getLastGeoPos();return t=this._oTipMarkerMgr.getTotalDist()+e.distanceTo(n),i.GeometryUtil.readableDistance(t,this.options.metric,this.options.feet)},_showErrorTooltip:function(){this._errorShown=!0,this._tooltip.showAsError().updateContent({text:this.options.drawError.message}),this._updateGuideColor(this.options.drawError.color),this._poly.setStyle({color:this.options.drawError.color}),this._clearHideErrorTimeout(),this._hideErrorTimeout=setTimeout(i.Util.bind(this._hideErrorTooltip,this),this.options.drawError.timeout)},_hideErrorTooltip:function(){this._errorShown=!1,this._clearHideErrorTimeout(),this._tooltip.removeError().updateContent(this._getTooltipText()),this._updateGuideColor(this.options.shapeOptions.color),this._poly.setStyle({color:this.options.shapeOptions.color})},_clearHideErrorTimeout:function(){this._hideErrorTimeout&&(clearTimeout(this._hideErrorTimeout),this._hideErrorTimeout=null)},_cancelDrawing:function(t){this._map.fire("draw:canceled",{layerType:this.type}),27===t.keyCode&&this._oParent.disable()}}),i.ExSunMap.Measure.dist=function(t,e){return new i.ExSunMap.Measure.Dist(t,e)},i.ExSunMap.Measure.MarkerMgr=i.Class.extend({statics:{TYPE:"DIST"},options:{icon:new i.DivIcon({iconSize:new i.Point(8,8),className:"leaflet-div-icon leaflet-editing-icon"}),zIndexOffset:2e3},initialize:function(t,e,n){this._map=t,this._oParent=e,i.setOptions(this,n),this._dTotalDist=0,this._markers=[],this._layerGroup=i.featureGroup(),this._map.addLayer(this._layerGroup)},createMarker:function(t,e){var n=i.extend({},e,{icon:this.options.icon,zIndexOffset:2*this.options.zIndexOffset}),o=new i.Marker(t,n);return this._layerGroup.addLayer(o),this._markers.push(o),o},getLen:function(){return this._markers?this._markers.length:0},getLastMarker:function(){return!this._markers||this._markers.length<=0?null:this._markers[this._markers.length-1]},getLastGeoPos:function(){return this.getLastMarker().getLatLng()},getPointMarkers:function(){var t=[];if(!this._markers||this._markers.length<=0)return t;for(var e=0;e<this._markers.length;e++)t.push(this._markers[e].getLatLng());return t},updateFinishHandler:function(){var t=this._markers.length;t>1&&(this._markers[t-1].on("click",this._finishShape,this),this._markers[t-1].on("dblclick",this._finishShape,this)),t>2&&(this._markers[t-2].off("click",this._finishShape,this),this._markers[t-2].on("dblclick",this._finishShape,this))},cleanUpShape:function(){this._markers<=1||this.getLastMarker().off("click",this._finishShape,this)},_finishShape:function(){this._oParent._finishShape()},removeMarker:function(t){for(var e=this._markers.length-1;e>=0;e--)if(this._markers[e]===t){this._markers.splice(e,1);break}this._layerGroup.removeLayer(t)},updateDist:function(){for(var t=0;t<this._markers;t++)if(0!==t){var e=this._tipMarkers[t].getLatLng().distanceTo(this._tipMarkers[t-1]);this._tipMarkers[t].setDist(e)}else this._tipMarkers[t].setDist(0)},clearData:function(){this._markers.splice(0,this._markers.length),this._layerGroup.clearLayers()},remove:function(){this._map.removeLayer(this._layerGroup),delete this._layerGroup,delete this._markers}}),i.ExSunMap.Measure.TipMarkerMgr=i.Class.extend({statics:{TYPE:"DIST"},initialize:function(t,e,n){this._map=t,i.setOptions(this,n),this._markers=[],this._layerGroup=i.featureGroup(),this._map.addLayer(this._layerGroup),this._oParent=e},options:{metric:!0},createMarker:function(t,e,n){var o=i.ExSunMap.Measure.tipMarker(t,this,n);o.addTo(this._layerGroup),this._markers.push(o);var a=this.getSecLastMarker(),s=this.calDist(o,a);return o.setDist(s),1===this._markers.length&&o.setBeginText(),this._markers.length>1&&(s=this.getTotalDist(),o.setSubTotalDist(s)),e&&(o.oRelaMarker=e),o},calDist:function(t,e){if(!e)return 0;var i=t.getLatLng(),n=e.getLatLng();return i.distanceTo(n)},getTotalDist:function(){if(this._markers.length<=0)return 0;for(var t=0,e=0;e<this._markers.length;e++)t+=this._markers[e].dDist;return t},getLastMarker:function(){return!this._markers||this._markers.length<=0?null:this._markers[this.getLen()-1]},getLastGeoPos:function(){return this.getLastMarker().getLatLng()},getSecLastMarker:function(){return!this._markers||this._markers.length<=1?null:this._markers[this.getLen()-2]},getLen:function(){return this._markers?this._markers.length:0},addCloseBtn:function(){var t=this.getLastMarker();t&&t.addAllClose()},addTotalDist:function(){var t=this.getLastMarker();if(t){var e=this.getTotalDist();t.addTotalPenal(e)}},setTipTotalDist:function(){var t=this.getLastMarker();if(t){var e=this.getTotalDist();t.setTotalDist(e)}},setSubDist:function(){if(this._markers&&!(this._markers.length<=0)){this._markers[0].setDist(0),this._markers[0].deleteSubTotalTag();for(var t=1;t<this._markers.length;t++){var e=this.calDist(this._markers[t],this._markers[t-1]);this._markers[t].setDist(e)}}},setTipSubTotalDist:function(){if(this._markers&&!(this._markers.length<=0))for(var t=0,e=1;e<this._markers.length;e++)t=this._markers[e].dDist+t,this._markers[e].setSubTotalDist(t)},update:function(){this.setSubDist(),this.setTipSubTotalDist(),this._oParent.options.bIsTotalDist?this.addTotalDist():this.setTipTotalDist(),this.addCloseBtn()},removeTipMarker:function(t){if(2===this._markers.length)return this.clearData(),void this._oParent.clearData();for(var e=this._markers.length-1;e>=0;e--)if(this._markers[e]===t){this._markers.splice(e,1);break}this.update(),t.oRelaMarker&&this._oParent.deleteHandler(t.oRelaMarker),this._layerGroup.removeLayer(t)},clearData:function(){this._markers.splice(0,this._markers.length),this._layerGroup.clearLayers()},deleteDist:function(){this.clearData(),this._oParent.clearData()},remove:function(){this._map.removeLayer(this._layerGroup),delete this._layerGroup,delete this._markers}}),i.ExSunMap.Measure.TipMarker=i.Marker.extend({options:{oShowConfig:{bIsSubDist:!1,bIsSubTotalDist:!0,bIsSubClose:!0},metric:!0},oUIConfig:{oSubBeginTxt:{nOrder:1,cTagName:"span"},oSubDist:{nOrder:2,cTagName:"span"},oSubTotalDist:{nOrder:3,cTagName:"span"},oTotalDist:{nOrder:4,cTagName:"span"},oSubClose:{nOrder:5,cTagName:"a",cClassName:"ex-dist-subclose ec-text-lg",cText:"",cHtml:i.ExSunMap.Measure.Msg.TipMarker.createIcon.closeText,bIsClick:!0},oTotalClose:{nOrder:6,cTagName:"a",cClassName:"ex-dist-close ec-icon-trash",cText:"",cHtml:""}},initialize:function(t,e,n){i.Util.extend(this.oUIConfig,n.oUIConfig);for(var o in this.oUIConfig)"span"===this.oUIConfig[o].cTagName&&(this.oUIConfig[o].metric=this.options.metric);i.Marker.prototype.initialize.call(this,t,n),this._oParent=e,this.aoTag=[]},_initIcon:function(){var t=this.options,e=this._map,n=e.options.zoomAnimation&&e.options.markerZoomAnimation,o=n?"leaflet-zoom-animated":"leaflet-zoom-hide",a=this.createIcon();i.DomUtil.addClass(a,o),t.keyboard&&(a.tabIndex="0"),this._icon=a,this._initInteraction(),t.riseOnHover&&this.on({mouseover:this._bringToFront,mouseout:this._resetZIndex}),t.opacity<1&&this._updateOpacity(),this._map._panes.markerPane.appendChild(this._icon)},_setIconStyles:function(t,e){var n,o=this.options,a=i.point(o[e+"Size"]);n=i.point(o.iconAnchor),!n&&a&&(n=a.divideBy(2,!0)),t.className="leaflet-marker-"+e+" "+o.className,n&&(t.style.marginLeft=-n.x+"px",t.style.marginTop=-n.y+"px"),a&&(t.style.width=a.x+"px",t.style.height=a.y+"px")},createIcon:function(){var t=i.DomUtil.create("div","");return this._setIconStyles(t,"icon"),this.oTagContanier=t,this.createTag(),t},createTag:function(){var t=this.options.oShowConfig;for(var e in t)if(t[e]){var n=e.replace("bIs","o");if(this.oUIConfig.hasOwnProperty(n)){var o=new i.ExSunMap.Measure.TipTag(this,this.oUIConfig[n]);o.setFlag(n),this.addTag(o),this.oUIConfig[n].bIsClick&&o.setClick(this.closeHanler,this)}}},addTag:function(t){var e=this.aoTag;if(e.length<=0)return e.push(t),void this.oTagContanier.appendChild(t.oTag);for(var i=e.length,n=0;n<e.length;n++)if(t.nOrder<e[n].nOrder){i=n;break}i===e.length?(this.oTagContanier.appendChild(t.oTag),this.aoTag.push(t)):(this.oTagContanier.insertBefore(t.oTag,this.aoTag[i].oTag),this.aoTag.splice(i,0,t))},addAllClose:function(){var t=this.getTagByFlag("oTotalClose")
;t||(t=i.ExSunMap.Measure.tipTag(this,this.oUIConfig.oTotalClose),t.setFlag("oTotalClose"),this.addTag(t),t.setClick(function(){this._oParent.deleteDist()},this))},deleteTag:function(t){var e=this.aoTag;if(e&&!(e.length<=0))for(var i=0;i<e.length;i++)if(e[i].cFlag===t){this.oTagContanier.removeChild(e[i].oTag),e.splice(i,1);break}},deleteSubTotalTag:function(){this.deleteTag("oSubTotalDist")},addTotalPenal:function(t){var e=this.getTagByFlag("oTotalDist");e||(e=i.ExSunMap.Measure.tipTag(this,this.oUIConfig.oTotalDist),e.setFlag("oTotalDist"),this.addTag(e)),this.setTotalDist(t,e)},setTotalDist:function(t,e){if(e||(e=this.getTagByFlag("oTotalDist")),e){this.deleteTag("oSubTotalDist");var n=i.ExSunMap.Measure.Msg.TipMarker.addTotalPenal.total;e.setHTML(t,n)}},setDist:function(t){this.dDist=t;var e=this.getTagByFlag("oSubDist");e&&e.setHTML(t)},setBeginText:function(){var t=new i.ExSunMap.Measure.TipTag(this,this.oUIConfig.oSubBeginTxt);t.setFlag("oSubBeginTxt"),this.addTag(t);var e=i.ExSunMap.Measure.Msg.TipMarker.setText.beginText;t.setHTML(e)},getTagByFlag:function(t){var e=this.aoTag;if(e&&!(e.length<=0))for(var i=0;i<e.length;i++)if(e[i].cFlag===t)return e[i]},setSubTotalDist:function(t){var e=this.getTagByFlag("oSubTotalDist");if(e){var n=i.ExSunMap.Measure.Msg.TipMarker.setSubTotalDistTag.total;e.setHTML(t,n)}},closeHanler:function(){this._oParent.removeTipMarker(this)}}),i.ExSunMap.Measure.tipMarker=function(t,e,n){return new i.ExSunMap.Measure.TipMarker(t,e,n)},i.ExSunMap.Measure.TipTag=i.Class.extend({options:{cTagName:"span",cClassName:"",nOrder:1,cText:""},initialize:function(t,e){i.setOptions(this,e),this._oParent=t,this.createTag()},createTag:function(){var t=i.DomUtil.create(this.options.cTagName,"");return this.nOrder=this.options.nOrder,this.options.cClassName&&i.DomUtil.addClass(t,this.options.cClassName),t.text=this.options.cText,t.innerHTML=this.options.cHtml||"",this.oTag=t,t},setFlag:function(t){this.cFlag=t,this.oTag.setAttribute("cFlag",t)},setHTML:function(t,e){if("string"==typeof t)return void(this.oTag.innerText=t);var n="";0!==t&&(n=i.GeometryUtil.readableDistance(t,!0)),this.oTag.innerHTML=(e||"")+n},setClick:function(t,e){i.DomEvent.on(this.oTag,"click",t,e)}}),i.ExSunMap.Measure.tipTag=function(t,e){return new i.ExSunMap.Measure.TipTag(t,e)},i.ExSunMap.Measure.AreaMgr=i.ExSunMap.Measure.DistMgr.extend({addHooks:function(){var t=i.ExSunMap.Measure.area(this._map,this,this.options);this.oLastDist=t,this.aoMeasureHandker.push(t),t.createDist()}}),i.ExSunMap.Measure.areaMgr=function(t,e){return new i.ExSunMap.Measure.AreaMgr(t,e)},i.ExSunMap.Measure.Area=i.ExSunMap.Measure.Dist.extend({statics:{TYPE:"area"},Poly:i.Polygon,options:{showArea:!1,shapeOptions:{stroke:!0,color:"#f06eaa",weight:2,opacity:1,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0},metric:!0},initialize:function(t,e,n){i.ExSunMap.Measure.Dist.prototype.initialize.call(this,t,e,n),this.type=i.ExSunMap.Measure.Area.TYPE},createDist:function(){this._map&&(i.DomUtil.disableTextSelection(),this._container.focus(),this._tooltip=new i.ExSunMap.Tooltip(this._map),i.DomEvent.on(this._container,"keyup",this._cancelDrawing,this),this._oMarkerMgr=new i.ExSunMap.Measure.AreaMarkerMgr(this._map,this),this._oTipMarkerMgr=new i.ExSunMap.Measure.AreaTipMarkerMgr(this._map,this),this._poly=new i.Polyline([],this.options.shapeOptions),this._tooltip.updateContent(this._getTooltipText()),this.initEvent())},_getTooltipText:function(){var t,e,n=this._oMarkerMgr.getLen();return 0===n?t=i.ExSunMap.Measure.Msg.Area._getTooltipText.start:n<3?t=i.ExSunMap.Measure.Msg.Area._getTooltipText.cont:(t=i.ExSunMap.Measure.Msg.Area._getTooltipText.end,e=this._getMeasurementString()),{text:t,subtext:e}},_getMeasurementString:function(){var t=this._area;return t?i.GeometryUtil.readableArea(t,this.options.metric):null},_shapeIsValid:function(){return this._oMarkerMgr.getLen()>=3},_vertexChanged:function(t,e){var n;!this.options.allowIntersection&&this.options.showArea&&(n=this._poly.getLatLngs(),this._area=i.GeometryUtil.geodesicArea(n)),i.ExSunMap.Measure.Dist.prototype._vertexChanged.call(this,t,e)},_cleanUpShape:function(){var t=this._markers.length;t>0&&(this._markers[0].off("click",this._finishShape,this),t>2&&this._markers[t-1].off("dblclick",this._finishShape,this))}}),i.ExSunMap.Measure.area=function(t,e,n){return new i.ExSunMap.Measure.Area(t,e,n)},i.ExSunMap.Measure.AreaMarkerMgr=i.ExSunMap.Measure.MarkerMgr.extend({updateFinishHandler:function(){var t=this._markers.length;1===t&&this._markers[0].on("click",this._finishShape,this),t>2&&(this._markers[t-1].on("dblclick",this._finishShape,this),t>3&&this._markers[t-2].off("dblclick",this._finishShape,this))}}),i.ExSunMap.Measure.AreaTipMarkerMgr=i.ExSunMap.Measure.TipMarkerMgr.extend({statics:{TYPE:"AREA"},createMarker:function(t,e,n){var o=new i.ExSunMap.Measure.AreaTipMarker(t,this,n);return o.addTo(this._layerGroup),this._markers.push(o),e&&(o.oRelaMarker=e),o},getTotalDist:function(){if(this._markers.length<=2)return 0;var t=this._markers.map(function(t){return t.getLatLng()});return i.GeometryUtil.geodesicArea(t)},removeTipMarker:function(t){if(3===this._markers.length)return this.clearData(),void this._oParent.clearData();for(var e=this._markers.length-1;e>=0;e--)if(this._markers[e]===t){this._markers.splice(e,1);break}this.update(),t.oRelaMarker&&this._oParent.deleteHandler(t.oRelaMarker),this._layerGroup.removeLayer(t)},update:function(){this._oParent.options.bIsTotalDist?this.addTotalDist():this.setTipTotalDist(),this.addCloseBtn()}}),i.ExSunMap.Measure.AreaTipMarker=i.ExSunMap.Measure.TipMarker.extend({options:{oShowConfig:{bIsSubDist:!1,bIsSubClose:!0},metric:!0},oUIConfig:{oTotalDist:{nOrder:3,cTagName:"span"},oSubClose:{nOrder:4,cTagName:"a",cClassName:"ex-dist-subclose ec-text-lg",cText:"",cHtml:i.ExSunMap.Measure.Msg.TipMarker.createIcon.closeText,bIsClick:!0},oTotalClose:{nOrder:5,cTagName:"a",cClassName:"ex-dist-close ec-icon-trash",cText:"",cHtml:""}},createTag:function(){var t=this.options.oShowConfig;for(var e in t)if(t[e]){var n=e.replace("bIs","o");if(this.oUIConfig.hasOwnProperty(n)){var o=new i.ExSunMap.Measure.AreaTipTag(this,this.oUIConfig[n]);o.setFlag(n),this.addTag(o),this.oUIConfig[n].bIsClick&&o.setClick(this.closeHanler,this)}}},addTotalPenal:function(t){var e=this.getTagByFlag("oTotalDist");e||(e=new i.ExSunMap.Measure.AreaTipTag(this,this.oUIConfig.oTotalDist),e.setFlag("oTotalDist"),this.addTag(e)),this.setTotalDist(t,e)}}),i.ExSunMap.Measure.AreaTipTag=i.ExSunMap.Measure.TipTag.extend({setHTML:function(t){if("string"==typeof t)return void(this.oTag.innerText=t);var e=i.ExSunMap.Measure.Msg.TipMarker.setText.beginText;0!==t&&(e=i.GeometryUtil.readableAreaEx(t,this.options.metric)),this.oTag.innerHTML=e}}),i.ExSunMap.LocaltionSearch={},i.ExSunMap.LocaltionSearch.version="2.4.0",i.ExSunMap.LocaltionSearch.Msg={addHooks:{locText:"move mouse to search localtion"},_onMouseMove:{locTemp:"lng:{lng},lat:{lat}"}},i.ExSunMap.LocaltionSearch.Search=i.Handler.extend({statics:{TYPE:"LocaltionSearch"},includes:i.Mixin.Events,initialize:function(t,e){i.Handler.prototype.initialize.call(this,t),i.setOptions(this,e),this._uneditedLayerProps={}},enable:function(){this._enabled||(this.fire("enabled",{handler:this.type}),this._map.fire("tool:localStart",{handler:this.type}),i.Handler.prototype.enable.call(this))},disable:function(){this._enabled&&(i.Handler.prototype.disable.call(this),this._map.fire("tool:localStop",{handler:this.type}),this.fire("disabled",{handler:this.type}))},addHooks:function(){var t=this._map;t&&(t.getContainer().focus(),this._tooltip=new i.ExSunMap.Tooltip(this._map),this._tooltip.updateContent({text:"",subtext:i.ExSunMap.LocaltionSearch.Msg.addHooks.locText}),i.DomUtil.addClass(this._map.getContainer(),"toopTipClass"),this._map.on("mousemove",this._onMouseMove,this).on("click",this._onClick,this))},removeHooks:function(){this._map&&(this._uneditedLayerProps={},this._tooltip.dispose(),this._tooltip=null,i.DomUtil.removeClass(this._map.getContainer(),"toopTipClass"),this._map.off("mousemove",this._onMouseMove,this).off("click",this._onClick,this))},_onClick:function(t){var n=this._map.getContainer(),o=i.DomUtil.create("input","",n);o.type="text";var a={lat:t.latlng.lat.toFixed(6),lng:t.latlng.lng.toFixed(6)};o.value=i.Util.template(i.ExSunMap.LocaltionSearch.Msg._onMouseMove.locTemp,a),o.select(),e.execCommand("Copy"),n.removeChild(o),this.disable()},_onMouseMove:function(t){var e={lat:t.latlng.lat.toFixed(6),lng:t.latlng.lng.toFixed(6)};this._tooltip.updateContent({text:i.ExSunMap.LocaltionSearch.Msg.addHooks.locText,subtext:i.Util.template(i.ExSunMap.LocaltionSearch.Msg._onMouseMove.locTemp,e)}),this._tooltip.updatePosition(t.latlng)}}),i.Map.mergeOptions({rectBox:!1}),i.Map.RectBox=i.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane},addHooks:function(){i.DomEvent.on(this._container,"mousedown",this._onMouseDown,this),i.DomUtil.addClass(this._container,"leaflet-crosshair"),this._map.dragging.disable()},removeHooks:function(){i.DomEvent.off(this._container,"mousedown",this._onMouseDown,this),i.DomUtil.removeClass(this._container,"leaflet-crosshair")},moved:function(){return this._moved},_resetState:function(){this._moved=!1},_onMouseDown:function(t){this._resetState(),i.DomUtil.disableTextSelection(),i.DomUtil.disableImageDrag(),this._startPoint=this._map.mouseEventToContainerPoint(t),"0.7.7"===i.version?i.DomEvent.on(e,"mousemove",this._onMouseMove,this).on(e,"mouseup",this._onMouseUp,this).on(e,"keydown",this._onKeyDown,this):i.DomEvent.on(e,{contextmenu:i.DomEvent.stop,mousemove:this._onMouseMove,mouseup:this._onMouseUp,keydown:this._onKeyDown},this)},_onMouseMove:function(t){this._moved||(this._moved=!0,this._box=i.DomUtil.create("div","leaflet-zoom-box",this._container),this._map.fire("rectboxstart")),this._point=this._map.mouseEventToContainerPoint(t);var e=new i.Bounds(this._point,this._startPoint),n=e.getSize();i.DomUtil.setPosition(this._box,e.min),this._box.style.width=n.x+"px",this._box.style.height=n.y+"px"},_finish:function(){this._moved&&("0.7.7"===i.version?(this._container.removeChild(this._box),this._container.style.cursor=""):(i.DomUtil.remove(this._box),i.DomUtil.removeClass(this._container,"leaflet-crosshair"))),this._map.dragging.enable(),i.DomUtil.enableTextSelection(),i.DomUtil.enableImageDrag(),"0.7.7"===i.version?i.DomEvent.off(e,"mousemove",this._onMouseMove).off(e,"mouseup",this._onMouseUp).off(e,"keydown",this._onKeyDown):i.DomEvent.off(e,{contextmenu:i.DomEvent.stop,mousemove:this._onMouseMove,mouseup:this._onMouseUp,keydown:this._onKeyDown},this)},_onMouseUp:function(t){if((1===t.which||1===t.button)&&(this._finish(),this._moved)){setTimeout(i.bind(this._resetState,this),0);var e=new i.LatLngBounds(this._map.containerPointToLatLng(this._startPoint),this._map.containerPointToLatLng(this._point));this._map.fire("rectboxend",{boxBounds:e}),this.endHandler(e)}},endHandler:function(){},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),i.Map.addInitHook("addHandler","rectBox",i.Map.RectBox),i.Map.ScaleBig=i.Map.RectBox.extend({endHandler:function(t){t&&(this._map.fitBounds(t),this.disable())}}),i.Map.ScaleSmall=i.Map.RectBox.extend({endHandler:function(t){t&&(this.zoomInBounds(t),this.disable())},zoomInBounds:function(t,e){var n=this._map.getZoom();e=e||{},t=t.getBounds?t.getBounds():i.latLngBounds(t);var o=i.point(e.paddingTopLeft||e.padding||[0,0]),a=i.point(e.paddingBottomRight||e.padding||[0,0]),s=this._map.getBoundsZoom(t,!1,o.add(a)),r=a.subtract(o).divideBy(2),h=this._map.project(t.getSouthWest(),s),l=this._map.project(t.getNorthEast(),s),c=this._map.unproject(h.add(l).divideBy(2).add(r),s),p=s-n==0?1:s-n;return s=e&&e.maxZoom?Math.min(e.maxZoom,s):n-p,this._map.setView(c,s,e)}}),i.Util.extend(i.LineUtil,{initTag:function(t,e){if(t&&e)for(var n in e)if(i.Util.isArray(e[n]))for(var o=n,a=0;a<e[o].length;a++){var s=i.DomUtil.create(o);this.initTag(s,e[o][a]),t.appendChild(s)}else if("object"==typeof e[n]&&null!==e[n]){var r=i.Util.replaceAll(n,"1",""),h=i.DomUtil.create(r);this.initTag(h,e[n]),t.appendChild(h)}else if("html"===n){var l=t.innerHTML;t.innerHTML=l+(null!==e[n]?e[n]:"")}else t.setAttribute(n,e[n])},replaceAll:function(t,e,i){return t.replace(new RegExp(e,"gm"),i)}}),i.ExSunMap.MapMaster={},i.ExSunMap.MapMaster.vertion="2.4.0",i.ExSunMap.MapMaster.TileProvider={oTianDiTu:{oNormal:{cName:"天地图",cMap:"http://t{s}.tianditu.cn/DataServer?T=vec_w&X={x}&Y={y}&L={z}",cAnnotion:"http://t{s}.tianditu.cn/DataServer?T=cva_w&X={x}&Y={y}&L={z}",acSubdomains:["0","1","2","3","4","5","6","7"]},oSatellite:{cName:"天地卫星图",cMap:"http://t{s}.tianditu.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}",cAnnotion:"http://t{s}.tianditu.cn/DataServer?T=cia_w&X={x}&Y={y}&L={z}",acSubdomains:["0","1","2","3","4","5","6","7"]},oTerrain:{cName:"天地地形图",cMap:"http://t{s}.tianditu.cn/DataServer?T=ter_w&X={x}&Y={y}&L={z}",cAnnotion:"http://t{s}.tianditu.cn/DataServer?T=cta_w&X={x}&Y={y}&L={z}",acSubdomains:["0","1","2","3","4","5","6","7"]}},oMapABC:{oNormal:{cName:"MapABC",cMap:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",acSubdomains:["a","b","c"]}},oGaoDe:{oNormal:{cName:"电子地图",cMap:"http://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",acSubdomains:["1","2","3","4"]},oSatellite:{cName:"高德卫星图",cMap:"http://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",acSubdomains:["1","2","3","4"]},oNetRoad:{cName:"高德路网图",cMap:"http://webst0{s}.is.autonavi.com/appmaptile?style=8&x={x}&y={y}&z={z}",acSubdomains:["1","2","3","4"]}},oExSunMap:{oNormal:{cName:"依迅本地图",cMap:"http://192.168.1.248:9000/map/get/{x}/{y}/{z}",acSubdomains:["1","2","3","4"]},oNormalSvr:{cName:"依迅服务器图",cMap:"http://221.235.53.42:8008/mapimg.aspx?t=mapabc&z={z}&x={x}&y={y}",acSubdomains:["1","2","3","4"]}},oGoogleMap:{oNormal:{cName:"谷歌地图",cMap:"http://mt2.google.cn/vt/lyrs=m@167000000&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}",acSubdomains:["1","2","3","4"]},oSatellite:{cName:"卫星图",cMap:"http://mt3.google.cn/vt/lyrs=s&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}",acSubdomains:["1","2","3","4"]},oTopographic:{cName:"谷歌地形图",cMap:"http://mt0.google.cn/vt/lyrs=t&hl=zh-CN&gl=cn&x={x}&y={y}&z={z}",nMaxLevel:16,acSubdomains:["1","2","3","4"]}},oArcMap:{oFoursquare:{cMap:"http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}",cName:"灰度图",acSubdomains:["1","2","3","4"]}},oTDMap:{oNormal:{cName:"立体图",cMap:"https://a.tiles.mapbox.com/v3/foursquare.map-0y1jh28j/{z}/{x}/{y}.png",acSubdomains:["1","2","3","4"]}}},i.ExSunMap.MapMaster.TileProvider[0]=i.ExSunMap.MapMaster.TileProvider.oTianDiTu.oNormal,i.ExSunMap.MapMaster.TileProvider[1]=i.ExSunMap.MapMaster.TileProvider.oTianDiTu.oSatellite,i.ExSunMap.MapMaster.TileProvider[2]=i.ExSunMap.MapMaster.TileProvider.oTianDiTu.oTerrain,i.ExSunMap.MapMaster.TileProvider[3]=i.ExSunMap.MapMaster.TileProvider.oMapABC.oNormal,i.ExSunMap.MapMaster.TileProvider[4]=i.ExSunMap.MapMaster.TileProvider.oGaoDe.oNormal,i.ExSunMap.MapMaster.TileProvider[5]=i.ExSunMap.MapMaster.TileProvider.oGaoDe.oSatellite,i.ExSunMap.MapMaster.TileProvider[6]=i.ExSunMap.MapMaster.TileProvider.oGaoDe.oNetRoad,i.ExSunMap.MapMaster.TileProvider[7]=i.ExSunMap.MapMaster.TileProvider.oExSunMap.oNormal,i.ExSunMap.MapMaster.TileProvider[8]=i.ExSunMap.MapMaster.TileProvider.oExSunMap.oNormalSvr,i.ExSunMap.MapMaster.TileProvider[9]=i.ExSunMap.MapMaster.TileProvider.oGoogleMap.oNormal,i.ExSunMap.MapMaster.TileProvider[10]=i.ExSunMap.MapMaster.TileProvider.oGoogleMap.oSatellite,i.ExSunMap.MapMaster.TileProvider[11]=i.ExSunMap.MapMaster.TileProvider.oGoogleMap.oTopographic,i.ExSunMap.MapMaster.TileProvider[12]=i.ExSunMap.MapMaster.TileProvider.oArcMap.oFoursquare,i.ExSunMap.MapMaster.TileProvider[13]=i.ExSunMap.MapMaster.TileProvider.oTDMap.oNormal,i.ExSunMap.MapMaster.Err={1:"没有设置图层！",2:"Map parent container not found."},i.ExSunMap.MapMaster.EventName={loadFinish:"Map:loadFinish"},i.ExSunMap.MapMaster=i.Evented.extend({options:{cDidId:"divMap",cDivContainerId:"divContainer",nDefaultTile:4,oMapOption:{zoomControl:!1,layers:[],center:new i.LatLng(30.55072,114.29471),zoom:10},oTileOption:{maxZoom:18,minZoom:3,attribution:'Map &copy;GB-20263—2018 <a target="_blank" href="#">电子地图</a> '},anLoadTile:[4,5,6,9,10,11,12],oProvider:i.ExSunMap.MapMaster.TileProvider,nMapWidth:600,nMapHeight:500},cDiv:"div",initialize:function(t,e){return i.setOptions(this,e),this._oParent=t,this._oBaseLayer={},this._oDefaultTile=void 0,this._initTile(),this._getDefaultLayer(),this},getDefaultTile:function(){var t=this.options.oProvider[this.options.nDefaultTile].cName;return this._oBaseLayer[t]},loadMapMaster:function(){return this._loadMap(),this},getMap:function(){return this._oMap},getBaseLayers:function(){if(!this._oBaseLayer)throw new Error(i.ExSunMap.MapMaster.Err[1]);return this._oBaseLayer},_getDefaultLayer:function(){var t=this.options.oProvider[this.options.nDefaultTile].cName;return this._oDefaultTile=this._oBaseLayer[t],this._oDefaultTile},_loadMap:function(){var t=i.DomUtil.get(this.options.cDidId),e=this.options.nMapWidth,n=this.options.nMapHeight;if(!t){var o=i.DomUtil.get(this.options.cDivContainerId);if(!o)throw new Error(i.ExSunMap.MapMaster.Err[2]);t=i.DomUtil.create(this.cDiv,"",o)}t.style.width=e+"px",t.style.height=n+"px",t.id=this.options.cDidId,i.Util.extend(this.options.oMapOption,{layers:[this._oDefaultTile]});var a=this._oMap=new i.Map(this.options.cDidId,this.options.oMapOption);return this._oParent&&(this._oParent.setMap&&this._oParent.setMap(a),this.fire("Map:loadFinish",{oMap:a})),a},_initTile:function(){var t=i.extend({},this.options.oTileOption),e=this.options.oProvider,n=this.options.anLoadTile;if(n&&!(n.length<=0)&&e){for(var o={},a=0;a<n.length;a++){var s=e[n[a]];t.maxZoom=s.nMaxLevel||t.maxZoom,t.minZoom=s.nMinLevel||t.minZoom,t.subdomains=s.acSubdomains;var r=i.tileLayer(s.cMap,t);o[s.cName]=r}this._oBaseLayer=o}},reflesh:function(t,e){if(this._oMap){var i=this._oMap.getContainer();t&&(i.style.width=t+"px"),e&&(i.style.height=e+"px"),this._oMap._onResize()}}}),i.ExSunMap.MapMaster.include({cTopLeftConfig:{div:{class:"ex-layout-maptool ex-theme-maptool ex-map-top ex-map-left"}},cTopRightConfig:{div:{class:"ex-layout-maptool ex-theme-maptool ex-map-top ex-map-left"}},initTopLeft:function(t){var e=i.DomUtil.get(this.options.cDidId);e&&(t?i.Util.initTag(e,t):i.Util.initTag(e,this.cTopLeftConfig))},initTopRight:function(){}}),i.ExSunMap.MapMaster.MapOpr=i.Evented.extend({options:{nFlyZoom:10,nFlyDuration:1,nFlyMaxZoom:15,cFlayMapVertion:"1.0"},initialize:function(t,e,n){e=i.setOptions(this,e),this._oParent=t,n&&n instanceof i.Map?this._oMap=n:t&&(t._oMap&&t._oMap instanceof i.Map?this._oMap=t._oMap:t instanceof i.Map&&(this._oMap=t)),this._initOn()},flyTo:function(t,e){if(this._oMap){var n=null;if(t.hasOwnProperty("oGpsInfo")){var o=t.oGpsInfo;n=i.latLng(o.Lat,o.Lon)}if(t instanceof i.LatLng&&(n=t),t.hasOwnProperty("lat")&&t.hasOwnProperty("lng")&&(n=i.latLng(t.lat,t.lng)),t.hasOwnProperty("Lat")&&t.hasOwnProperty("Lng")&&(n=i.latLng(t.Lat,t.Lng)),!(i.version<this.options.cFlayMapVertion))return this._oMap.getBounds().contains(n)&&this._oMap.getZoom()>=this.options.nFlyMaxZoom?void this._oMap.panTo(n):(e||(e={}),this._oMap.flyTo(n,e.zoom||this.options.nFlyZoom,{duration:e.duration||this.options.nFlyDuration}),this)}},reflesh:function(){if(this._oMap)return this._oMap._onResize(),this},findLayer:function(t,e){if(!t||t.getLayers().length<=0)return null;var i=t.getLayers();for(var n in i)if(i[n].cId===e)return i[n];return null},findLayerInMap:function(t){if(!this._oMap)return null;var e=this._oMap._layers;if(!e)return null;var i=[];for(var n in e)e[n].cId===t&&i.push(e[n]);return i},posInSrceen:function(t){return!!this._oMap&&this._oMap.getBounds().contains(t)},_drawTip:function(t,e){var n={cId:"1",cName:"测试tip",bNoHide:!0};i.Util.extend(n,e);var o=new i.DivIcon({html:"<div> </div>",className:""}),a=i.marker(t,{icon:o,bIsNotEdit:!0});return a.cId="TM_"+n.cId,a.bindLabel(n.cName,{noHide:n.bNoHide,direction:"auto"}),a},setMap:function(t){return t instanceof i.Map&&(this._oMap=t),this},delPosNotInScreen:function(t,e){if(t&&!(t.length<=0)){e||(e=this.oMap.getBounds());for(var n=t.length-1;n>=0;n--){var o=i.latLng(t[n].oLatLng.lat,t[n].oLatLng.lng);e.contains(o)||t.splice(n,1)}return this}},_loadPage:function(){},_initOn:function(){}}),i.ExSunMap.Layout=i.Evented.extend({options:{pContainer:"ex-layout-content",mapDivId:"MapView"},initialize:function(t,e){i.setOptions(this,e),this._oParent=t,this.pContainer=e.pContainer,"object"!=typeof e.pContainer&&(this.pContainer=$(this.options.pContainer)),this.initUI(),this.initOn()},initUI:function(){var t=i.DomUtil.create("div","ex-layout-map-content",this.pContainer);i.DomUtil.create("div","ex-map-top ex-map-left ",t),i.DomUtil.create("div","ex-map-top ex-map-right",t),i.DomUtil.create("div","ex-map-bottom ex-map-left",t),i.DomUtil.create("div","ex-map-bottom ex-map-right",t),this.container=t,t.id=this.options.mapDivId},initOn:function(){this._oParent&&this._oParent.on("MapControl:Layout.addToolItem",this.addToolItem,this)},addToolItem:function(t){},_addToolItem:function(t){},getWidth:function(){return this.container.width()},dueWidth:function(t){this.container.width(this.container.width()-t)},setWidth:function(t){this.container.width(t)}}),i.ExSunMap.ESMapMaster=i.Evented.extend({options:{containerClass:"ex-layout-content",mapContainerId:"mapview",lat:30.222,lng:113.255,nFlyZoom:10,nFlyDuration:1,nFlyMaxZoom:15,cFlayMapVertion:"1.0"},initialize:function(t,n){i.setOptions(this,n),this._oParent=t;var o=e.getElementsByClassName(n.containerClass);!o||o.length<=0||(this.pContainer=o[0],this.initUI())},initUI:function(){var t=i.DomUtil.create("div","ex-layout-map-content",this.pContainer);this.container=t,t.id=this.options.mapContainerId,i.DomUtil.create("div","layout-map-poi",t),i.DomUtil.create("div","layout-map-tool",t)},loadMap:function(t,e){return this.oMapMaster=new i.ExSunMap.MapMaster(this._oParent,{cDidId:this.options.mapContainerId,oMapOption:{zoomControl:!1,layers:[],center:new i.LatLng(this.options.lat,this.options.lng),zoom:10},nMapWidth:t,nMapHeight:e}),this.oMapMaster.loadMapMaster(),this.oMapMaster},resize:function(t,e){this.container.style.width=t+"px",this.container.style.height=e+"px",this.oMapMaster.reflesh(t,e)},getMap:function(){return this.oMapMaster.getMap()},loadSearch:function(t){this.search=new i.ExSunMap.ESMapSearch(this.oMapMaster,t)},loadToolBox:function(t){this.search=new i.ExSunMap.ESMapToolBox(this.oMapMaster,t)},loadMapTile:function(t){this.search=new i.ExSunMap.ESMapTile(this.oMapMaster,t)},loadMapFull:function(t){this.oToolFull=new i.ExSunMap.ESMapFull(this.oMapMaster,t)},posInSrceen:function(t){return!!this.getMap()&&this.getMap().getBounds().contains(t)},flyTo:function(t,e){if(this.getMap()){var n=null;if(t instanceof i.LatLng&&(n=t),t.hasOwnProperty("lat")&&t.hasOwnProperty("lng")&&(n=i.latLng(t.lat,t.lng)),t.hasOwnProperty("Lat")&&t.hasOwnProperty("Lng")&&(n=i.latLng(t.Lat,t.Lng)),!(i.version<this.options.cFlayMapVertion))return this.getMap().getBounds().contains(n)&&this.getMap().getZoom()>=this.options.nFlyMaxZoom?void this.getMap().panTo(n):(e||(e={}),this.getMap().flyTo(n,e.zoom||this.options.nFlyZoom,{duration:e.duration||this.options.nFlyDuration}),this)}},reflesh:function(){if(this.getMap())return this.getMap()._onResize(),this},findLayer:function(t,e){if(!t||t.getLayers().length<=0)return null;var i=t.getLayers();for(var n in i)if(i[n].cId===e)return i[n];return null},findLayerInMap:function(t){if(!this.getMap())return null;var e=this.getMap()._layers;if(!e)return null;var i=[];for(var n in e)e[n].cId===t&&i.push(e[n]);return i}}),i.ExSunMap.ESMapEdit=i.Evented.extend({options:{cParentDiv:"MapView",acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-left","ex-maptool-edit"],cBtnContain:".ex-map-tool-edit",className:"",title:"图层编辑",penStyle:{stroke:!0,color:"#0FFF05",dashArray:null,lineCap:null,lineJoin:null,weight:3,opacity:1,fill:!0,fillColor:null,fillOpacity:.2,clickable:!0,smoothFactor:1,noClip:!1}},hide:function(t){t.style.display="none"},show:function(t){t.style.display="block"},initialize:function(t,n){i.extend(this.options,n),this.oPenStyle=this.options.penStyle,this._mapMaster=t,this._oMap=t.getMap(),this._oDrawLayer=i.featureGroup(),this._oDrawLayer.addTo(this._oMap);var o=e.getElementsByClassName(this.options.acParentDivClass.join(" "));o<=0||(this.pContainer=o[0],this.cFlag="add",this.setParentEvent(),this.initPen(),this.initUI(),this.initCallBack(),this.initOn())},initOn:function(){this._oMapBase._oParent.on("ESMapEdit:showEditDraw",this.showEditAdd,this),this._oMapBase._oParent.on("ESMapEdit:clearLayers",this.clearLayers,this),this._oMapBase._oParent.on("ESMapEdit:deleteFence",this.deleteFence,this),this._oMapBase._oParent.on("ESMapEdit:editDraw",this.editDraw,this)},editDraw:function(t){this.cFlag="edit";var e=t.MapX.split(","),n=t.MapY.split(",");if(e&&n&&!(e.length<=0)){for(var o=[],a=0;a<e.length;a++){var s=i.latLng(parseFloat(n[a]),parseFloat(e[a]));o.push(s)}var r=i.polygon(o,this.oPenStyle).addTo(this._oDrawLayer);r.cId=t.Id,r.oFenceInfo=t,r.bindTooltip(t.Name).openTooltip(),this.fitBound(),this.$_btnPlus.hide(),this.$_btnEdit.show(),this.$_btnDel.show(),this.$_btnCal.hide(),this.$_btnSave.hide(),this.dealEditUI()}},fitBound:function(){if(this._oDrawLayer){var t=this._oDrawLayer.getBounds();this._oMap.fitBounds(t)}},drawTip:function(t){var e={bIsNotEdit:!0,cName:"测试tip显示名称",oLatLng:{lat:30.333,lng:113.333},bNoHide:!0};i.extend(e,t);var n=new i.DivIcon({html:"<div> </div>",className:""}),o=i.marker(e.oLatLng,{icon:n,bIsNotEdit:e.bIsNotEdit});return o.cId=e.cId,o.bindLabel(e.cName,{noHide:e.bNoHide,direction:"auto"}),o},deleteFence:function(){this._oDrawLayer.clearLayers(),this.$_btnCal.hide(),this.$_btnEdit.hide(),this.dealEditUI()},clearLayers:function(){this._oDrawLayer.clearLayers(),this.$_btnCal.hide(),this.dealEditUI()},showEditAdd:function(){this.cFlag="add",this.show(),this.clearLayers(),$(this.oOption.cBtnContain).find(".ec-icon-plus").parent().click()},dealEditUI:function(){for(var t=this._oContainer.getElementsByTagName("a"),e=!1,i=0;i<t.length;i++)"none"!==t[i].style.display&&(e=!0);e?this.show(this._oContainer):this.hide(this._oContainer)},initPen:function(){this.oDrawPen={enabled:{shapeOptions:this.oPenStyle},handler:new i.Draw.Polygon(this._oMap,{shapeOptions:this.oPenStyle}),title:i.drawLocal.draw.toolbar.buttons.polygon},this.oEditPen={enabled:this.oPenStyle,handler:new i.EditToolbar.Edit(this._oMap,{featureGroup:this._oDrawLayer,selectedPathOptions:{dashArray:"10, 10",fill:!0,fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1},poly:{allowIntersection:!1}}),title:i.drawLocal.edit.toolbar.buttons.edit}},setParentEvent:function(){},initUI:function(){var t=i.DomUtil.create("div","ex-maptool-box",this.pContainer),e=i.DomUtil.create("ul","ec-avg-sm-1 ex-map-tool-edit",t);this._createTool(e),this.initEven();this.oOption.cBtnContain;this.hide(this.btnPlus),this.hide(this.btnEdit),this.hide(this.btnCal),this.hide(this.btnSave),this.hide(this.btnDel),this.dealEditUI()},_createTool:function(t){var e=i.DomUtil.create("li","",t);this.btnPlus=i.DomUtil.create("a","ec-icon-plus",e),this.btnPlus.text("&nbsp;&nbsp;绘制"),e=i.DomUtil.create("li","",t),this.btnEdit=i.DomUtil.create("a","ec-icon-pencil",e),this.btnEdit.text("&nbsp;编&nbsp;&nbsp;辑"),e=i.DomUtil.create("li","",t),this.btnCal=i.DomUtil.create("a","ec-icon-power-off",e),this.btnCal.text("&nbsp;删&nbsp;&nbsp;除"),e=i.DomUtil.create("li","",t),this.btnSave=i.DomUtil.create("a","ec-icon-save",e),this.btnSave.text("&nbsp;确&nbsp;&nbsp;定"),e=i.DomUtil.create("li","",t),this.btnDel=i.DomUtil.create("a","ex-map-tool-cancel",e),this.btnDel.text("&nbsp;取&nbsp;&nbsp;消")},initEven:function(){var t=this;i.DomEvent.on(this.btnPlus,"click",function(){t.oDrawPen.handler.enable(),t.btnPlus.hide(),t.btnSave.hide(),t.btnEdit.hide(),t.hide(this.btnPlus),t.hide(this.btnEdit),t.hide(this.btnSave),t.show(this.btnCal),t.dealEditUI()},this),i.DomEvent.on(this.btnSave,"click",function(){t.oEditPen.handler.save(),t.oEditPen.handler.disable(),t.hide(this.btnPlus),t.hide(this.btnEdit),t.hide(this.btnCal),t.hide(this.btnSave),t.dealEditUI()},this),i.DomEvent.on(this.btnEdit,"click",function(){this.hide(this.btnEdit),this.show(this.btnSave),this.show(this.btnCal),this.dealEditUI(),this.oEditPen.handler.enable()}),i.DomEvent.on(this.btnCal,"click",function(){"add"===t.cFlag&&(this.hide(this.btnPlus),this.hide(this.btnSave),this.hide(this.btnCal),this.hide(this.btnEdit)),"edit"===t.cFlag&&(this.hide(this.btnPlus),this.hide(this.btnSave),this.hide(this.btnCal),this.show(this.btnEdit)),t.oDrawPen.handler.disable(),t.oEditPen.handler.revertLayers(),t.oEditPen.handler.disable(),t.dealEditUI()},this),i.DomEvent.on(this.btnDel,"click",function(){this.hide(this.btnDel),"add"===t.cFlag&&(this.hide(this.btnPlus),this.hide(this.btnSave),this.hide(this.btnCal),this.hide(this.btnEdit)),"edit"===t.cFlag&&(this.hide(this.btnPlus),this.hide(this.btnSave),this.hide(this.btnCal),this.show(this.btnEdit)),t.cFlag,t.oDrawPen.handler.disable(),t.oEditPen.handler.revertLayers(),t.oEditPen.handler.disable(),t.dealEditUI()})},initCallBack:function(){var t=this;this._oMap.on("draw:created",function(e){var i=e.layer;t._oDrawLayer.addLayer(i);var n=t._getGisObj(i);t._oMapBase._oParent.fire("FenceView:UI.addFence",n)}),this._oMap.on("draw:edited",function(e){e.layers.eachLayer(function(e){var i=t._getGisObj(e);t._oDrawLayer.addLayer(e),i.cId=e.cId,i.oFenceInfo=e.oFenceInfo,t._oMapBase._oParent.fire("FenceView:UI.updateFence",i)})})},getDrawModeHandlers:function(){return[{enabled:this.options.polyline,handler:new i.Draw.Polyline(this._oMap,this.options.polyline),title:i.drawLocal.draw.toolbar.buttons.polyline},{enabled:{shapeOptions:this.oPenStyle},handler:new i.Draw.Polygon(this._oMap,{shapeOptions:this.oPenStyle}),title:i.drawLocal.draw.toolbar.buttons.polygon},{enabled:this.options.rectangle,handler:new i.Draw.Rectangle(this._oMap,this.options.rectangle),title:i.drawLocal.draw.toolbar.buttons.rectangle},{enabled:this.options.circle,handler:new i.Draw.Circle(this._oMap,this.options.circle),title:i.drawLocal.draw.toolbar.buttons.circle},{enabled:this.options.marker,handler:new i.Draw.Marker(this._oMap,this.options.marker),title:i.drawLocal.draw.toolbar.buttons.marker}]},getEditModeHandlers:function(){return[{enabled:this.oPenStyle,handler:new i.EditToolbar.Edit(this._oMap,{featureGroup:this._oDrawLayer,selectedPathOptions:this.options.edit.selectedPathOptions,poly:this.options.poly}),title:i.drawLocal.edit.toolbar.buttons.edit},{enabled:{},handler:new i.EditToolbar.Delete(this._oMap,{featureGroup:this._oDrawLayer}),title:i.drawLocal.edit.toolbar.buttons.remove}]},_getGisObj:function(t){var e={},n=t.options;if(t instanceof i.Circle){var o=t.getLatLng();e={aoLatLng:[o,i.latLng([o.lat+t._getLatRadius(),o.lng])],dRadius:t.getRadius(),oOption:n,nType:this.getObjType(t)}}else e={aoLatLng:t.getLatLngs(),oOption:n,nType:this.getObjType(t)};return e},getObjType:function(t){return t instanceof i.Rectangle?3:t instanceof i.Polygon?1:t instanceof i.Polyline?4:t instanceof i.Circle?2:1}}),i.ExSunMap.ESMapFull=i.Evented.extend({options:{cSelfDiv:"ex-map-full",acParentDivClass:["ex-layout-maptool","ex-theme-maptool","ex-map-top","ex-map-right"],cClassName:"",cTitle:"地图全屏"},initialize:function(t,n){i.extend(this.options,n),this._mapMaster=t,this._oMap=t.getMap(),this._layers={},this._lastZIndex=0;var o=e.getElementsByClassName(this.options.acParentDivClass.join(" "));o<=0||(this.pContainer=o[0],this.initUI(),this.setParentEvent())},setParentEvent:function(){},initUI:function(){this.container=i.DomUtil.create("div","ex-maptool-box ex-map-full",this.pContainer),this.container.innerHTML="&nbsp;&nbsp;全屏",
i.DomUtil.create("i","ec-icon-expand",this.container),this.initToolEvent()},initToolEvent:function(){i.DomEvent.on(this.container,"click",function(){this.isFullscreen?($("body").removeClass("map_full"),this.container.innerHTML='<i class="ec-icon-expand"></i>&nbsp;&nbsp;全屏'):($("body").addClass("map_full"),this.container.innerHTML='<i class="ec-icon-compress"></i>&nbsp;&nbsp;恢复')},this)}}),i.ExSunMap.ESMapTile=i.Evented.extend({options:{cParentDiv:"MapView",acParentDivClass:["layout-map-tool"],cClassName:"",title:"图层切换"},initialize:function(t,n){i.extend(this.options,n),this._mapMaster=t,this._oMap=t.getMap(),this._layers={},this._lastZIndex=0;var o=e.getElementsByClassName(this.options.acParentDivClass.join(" "));if(!(o<=0)){this.pContainer=o[0];var a=this._mapMaster.getBaseLayers();for(var s in a)this._addLayer(a[s],s);this.initUI(),this.setParentEvent()}},_addLayer:function(t,e,n){var o=i.stamp(t);this._layers[o]={layer:t,name:e,overlay:n},this.options.autoZIndex&&t.setZIndex&&(this._lastZIndex++,t.setZIndex(this._lastZIndex))},setParentEvent:function(){i.DomEvent.addListener(this.container,"click",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"dblclick",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"mousemove",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"mousewheel",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"touchmove",i.DomEvent.stopPropagation)},initUI:function(){this.container=i.DomUtil.create("div","",this.pContainer),i.DomUtil.create("i","ec-icon-clone",this.container),this.span=i.DomUtil.create("span","",this.container),this.span.innerHTML="电子地图",i.DomUtil.create("i","ec-icon-angle-down",this.container);var t=i.DomUtil.create("ul","ec-avg-sm-1 ec-dropdown-content",this.container);this.initToolEvent(t)},initToolEvent:function(t){var e=this,n=i.DomUtil.create("li","",t),o=i.DomUtil.create("a","",n);o.innerHTML='<i class="ex-icon-maptool ex-maptool-china">&nbsp;电子地图</i>',i.DomEvent.on(o,"click",function(t){this.container.getElementsByTagName("span")[0].innerText=t.target.innerText;var i=t.target.innerText.trim();e.selectLayer(i)},this),n=i.DomUtil.create("li","",t),o=i.DomUtil.create("a","",n),o.innerHTML='<i class="ex-icon-maptool ex-maptool-china">&nbsp;卫星图</i>',i.DomEvent.on(o,"click",function(t){this.container.getElementsByTagName("span")[0].innerText=t.target.innerText;var i=t.target.innerText.trim();e.selectLayer(i)},this),n=i.DomUtil.create("li","",t),o=i.DomUtil.create("a","",n),o.innerHTML='<i class="ex-icon-maptool ex-maptool-china">&nbsp;灰度图</i>',i.DomEvent.on(o,"click",function(t){var i=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=t.target.innerText,e.selectLayer(i)},this),i.DomEvent.on(this.container,"mouseover mouseout",function(t){e._oMap.doubleClickZoom.disable(),e._oMap.doubleClickZoom.enable()},this)},selectLayer:function(t){"灰度图"===t&&this._oMap.getZoom()>16&&this._oMap.setZoom(16);for(var e in this._layers){var i=this._layers[e];i.name!==t||this._oMap.hasLayer(i.layer)?this._oMap.hasLayer(i.layer)&&i.name!==t&&this._oMap.removeLayer(i.layer):this._oMap.addLayer(i.layer)}}}),i.ExSunMap.ESMapToolBox=i.Evented.extend({options:{cParentDiv:"MapView",acParentDivClass:["layout-map-tool"],cClassName:"",title:"图层切换"},initialize:function(t,i){this._mapMaster=t,this._oMap=t.getMap();var n=e.getElementsByClassName(this.options.acParentDivClass.join(" "));n<=0||(this.pContainer=n[0],this.initUI(),this.initMapTool(),this.oActHandler=null,this.setParentEvent())},initMapTool:function(){this.oScaleBig=new i.Map.ScaleBig(this._oMap),this.oScaleSmall=new i.Map.ScaleSmall(this._oMap),this.oDistantHandler=i.ExSunMap.Measure.distMgr(this._oMap),this.oAreaHandler=i.ExSunMap.Measure.areaMgr(this._oMap,{}),this.oMapToolLocal=new i.ExSunMap.LocaltionSearch.Search(this._oMap)},setParentEvent:function(){i.DomEvent.addListener(this.container,"click",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"dblclick",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"mousemove",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"mousewheel",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"touchmove",i.DomEvent.stopPropagation)},initUI:function(){this.container=i.DomUtil.create("div","",this.pContainer),i.DomUtil.create("i","ec-icon-briefcase",this.container),this.span=i.DomUtil.create("span","",this.container),this.span.innerHTML="工具",i.DomUtil.create("i","ec-icon-angle-down",this.container);var t=i.DomUtil.create("ul","ec-avg-sm-1 ec-dropdown-content",this.container);this.initToolEvent(t)},initToolEvent:function(t){var e=i.DomUtil.create("li","",t),n=i.DomUtil.create("a","",e);n.innerHTML='<i class="ex-icon-maptool ex-maptool-china">&nbsp;全国</i>',i.DomEvent.on(n,"click",function(t){var e=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=e,this.oActHandler&&this.oActHandler.disable(),this._oMap.setView(new i.LatLng(35,103.5),4)},this),e=i.DomUtil.create("li","",t),n=i.DomUtil.create("a","",e),n.innerHTML='<i class="ex-icon-maptool ex-maptool-range">&nbsp;测距</i>',i.DomEvent.on(n,"click",function(t){var e=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=e,this.oActHandler&&this.oActHandler.disable(),this.oActHandler=this.oDistantHandler,this.oActHandler.enable()},this),e=i.DomUtil.create("li","",t),n=i.DomUtil.create("a","",e),n.innerHTML='<i class="ex-icon-maptool ex-maptool-area">&nbsp;测面</i>',i.DomEvent.on(n,"click",function(t){var e=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=e,this.oActHandler&&this.oActHandler.disable(),this.oActHandler=this.oAreaHandler,this.oActHandler.enable()},this),e=i.DomUtil.create("li","",t),n=i.DomUtil.create("a","",e),n.innerHTML='<i class="ex-icon-maptool ex-maptool-scale-big">&nbsp;拉框放大</i>',i.DomEvent.on(n,"click",function(t){var e=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=e,this.oActHandler&&this.oActHandler.disable(),this.oActHandler=this.oScaleBig,this.oActHandler.enable()},this),e=i.DomUtil.create("li","",t),n=i.DomUtil.create("a","",e),n.innerHTML='<i class="ex-icon-maptool ex-maptool-scale-small">&nbsp;拉框缩小</i>',i.DomEvent.on(n,"click",function(t){var e=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=e,this.oActHandler&&this.oActHandler.disable(),this.oActHandler=this.oScaleSmall,this.oActHandler.enable()},this),e=i.DomUtil.create("li","",t),n=i.DomUtil.create("a","",e),n.innerHTML='<i class="ex-icon-maptool ex-maptool-location">&nbsp;坐标查询</i>',i.DomEvent.on(n,"click",function(t){var e=t.target.innerText.trim();this.container.getElementsByTagName("span")[0].innerText=e,this.oActHandler&&this.oActHandler.disable(),this.oActHandler=this.oMapToolLocal,this.oActHandler.enable()},this)}}),i.ExSunMap.ESMapSearch=i.Evented.extend({options:{cParentDiv:"MapView",acParentDivClass:["layout-map-poi"],className:"",title:"图层切换",cUrl:"/MapView/PoiSearch",oParam:{key:"",keywords:"",types:"050301",location:"113.22,30.333",city:"",citylimit:"",datatype:"poi",output:"JSON"}},initialize:function(t,n){i.extend(this.options,n),this._mapMaster=t,this._oMap=t.getMap(),this.oLayer=i.featureGroup(),this.oInputData=null,this.oLayer.addTo(this._oMap);var o=(this._oMap.getContainer(),e.getElementsByClassName(this.options.acParentDivClass.join(" ")));o<=0||(this.oPContainer=o[0],this.initUI(),this.setParentEvent(),this.initToolEvent())},setParentEvent:function(){i.DomEvent.addListener(this.container,"dblclick",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"mousemove",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"mousewheel",i.DomEvent.stopPropagation),i.DomEvent.addListener(this.container,"touchmove",i.DomEvent.stopPropagation)},initUI:function(){this.container=i.DomUtil.create("div","ec-input-group ex-maptool-search-box",this.oPContainer),this.input=i.DomUtil.create("input","ec-form-field",this.container);var t=i.DomUtil.create("span","ec-input-group-btn",this.container);this.ul=i.DomUtil.create("ul","ex-maptool-box-search-result",this.container),this.search=i.DomUtil.create("button","ec-btn ec-btn-primary ec-btn-sm search",t),this.clear=i.DomUtil.create("button","ec-btn ec-btn-default ec-btn-sm clear",t),this.search.innerHTML='<span class="ec-icon-search"></span>',this.clear.innerHTML='<span class="ec-icon-close"></span>',i.ExSunMap.hide(this.search)},initToolEvent:function(){var n=this,o=!1;i.DomEvent.on(e,"keyup",function(e){var a=e||t.event,s=a.keyCode;38!=s&&40!=s&&(n.oInputData&&n.oInputData.name===this.input.value||(o&&clearTimeout(o),o=setTimeout(function(){var t=n.input.value,e=n._oMap.getCenter(),o={};i.extend(o,n.options.oParam,{keywords:t,location:e.lng+","+e.lat}),i.getData(JSON.stringify(o),n.options.cUrl,n.searchPoiHandler,n)},250)))},this),i.DomEvent.on(e,"keydown",function(e){if("none"!==this.search.style.display){var i=e||t.event,n=i.keyCode;if(38===n?this.movePrev():40===n&&this.moveNext(),13===n){var o=this.ul.getElementsByClassName("ec-active");this.localPos(o[0].oData),this.ul.innerHTML=""}}},this),i.DomEvent.on(this.clear,"click",function(t){this.oLayer.clearLayers(),this.input.value=""},this);i.DomEvent.on(this.search,"click",function(t){var e=this.input.value,n=this._oMap.getCenter(),o={};i.extend(o,this.options.oParam,{keywords:e,location:n.lng+","+n.lat}),i.getData(JSON.stringify(o),this.options.cUrl,this.searchPoiHandler,this)},this)},localPos:function(t){this.oLayer.clearLayers();var e=i.marker([t.lat,t.lng]);e.oData=t,e.addTo(this.oLayer),this._oMap.flyTo([t.lat,t.lng],16),this.input.value=t.name,this.oInputData=t,this.ul.innerHTML="",i.ExSunMap.hide(this.search)},getSelectIndex:function(t){for(var e=0;e<t.length;e++)if(i.DomUtil.hasClass(t[e],"ec-active"))return e;return-1},movePrev:function(){var t=this.ul.getElementsByTagName("li");if(i.DomUtil.hasClass(t[0],"ec-active"))return this.input.focus(),!1;var e=this.getSelectIndex(t);i.DomUtil.removeClass(t[e],"ec-active"),i.DomUtil.addClass(t[e-1],"ec-active");var n=t[e-1].oData;this.input.value=n.name},moveNext:function(){var t=this.ul.getElementsByTagName("li"),e=this.getSelectIndex(t,"ec-active");if(-1===e)return i.DomUtil.addClass(t[0],"ec-active"),this.input.value=t[0].oData.name,!1;if(e===t.length-1)return!1;i.DomUtil.removeClass(t[e],"ec-active"),i.DomUtil.addClass(t[e+1],"ec-active");var n=t[e+1].oData;this.input.value=n.name},searchPoiHandler:function(t){if(this.ul.innerHTML="",i.ExSunMap.hide(this.search),(t=JSON.parse(t).detail)&&0!==t.status&&!(t.count<=0)){for(var e=0;e<t.tips.length;e++)if(0!==t.tips[e].lng){t.tips[e].cDist=t.tips[e].district||"";var n=i.DomUtil.create("li","location",this.ul);n.innerHTML=i.Util.template(" <b>{name}</b><span>{cDist}</span> ",t.tips[e]),n.oData=t.tips[e],i.DomEvent.on(n,"click",function(t){this.localPos(t.currentTarget.oData)},this),i.DomEvent.on(n,"mouseover",function(t){i.DomUtil.addClass(t.currentTarget,"ec-active")},this),i.DomEvent.on(n,"mouseout",function(t){i.DomUtil.removeClass(t.currentTarget,"ec-active")},this)}i.ExSunMap.show(this.search),i.ExSunMap.show(this.ul)}}}),i.ExSunMap.VehClusterLayer=i.Evented.extend({options:{url:"",onDrawLayers:"MapView:ClusterLayer.DrawLayers",onClearLayers:"MapView:ClusterLayer.clearLayer",onRemoveLayers:"MapView:ClusterLayer.removeLayers",cHtml:'<div cid="{devNo}" class="car-body" style="transform:rotate({dir}deg);-webkit-transform: rotate({dir}deg);"></div>    <div class="pin-tip " style="display: block;">        <div class="pin-dome">       </div>        <div class="pin-number">{vehNo}</div>        <div class="pin-state">        </div></div>'},oPopOption:{maxWidth:500,autoPan:!1},initialize:function(t,e,n){i.setOptions(this,e),this._oMap=n,this._oParent=t,this._initGroup(),this._loadOn()},_initGroup:function(){this._oPosGroup=i.markerClusterGroup({}),this._oMap.addLayer(this._oPosGroup)},_loadOn:function(){var t=this;this._oParent.$on(this.options.onDrawLayers,this.drawLayers,this),this._oParent.$on(this.options.onClearLayers,this.clearLayer,this),this._oParent.$on(this.options.onRemoveLayers,this.removeLayers,this),this._oParent.$on("MapView:ClusterLayer.removeLayer",this.removeLayer,this),this._oParent.$on("MapView:MapLive.addMarker",function(e){t.drawLayer(e.oGpsInfo)},this)},removeLayer:function(t){this._oPosGroup&&t&&t.oGpsInfo&&this._removeLayer(t.oGpsInfo)},removeLayers:function(t){if(this._oPosGroup&&t&&!(t.acId.length<=0))for(var e=t.acId,i=0;i<e.length;i++){var n=-parseInt(e[i]);this._removeLayer(n)}},_removeLayer:function(t){},clearLayer:function(){this._oPosGroup.clearLayers()},drawLayers:function(t){if(t&&t.aoData&&!(t.aoData.length<=0))for(var e=0;e<t.aoData.length;e++)this.drawLayer(t.aoData[e])},drawLayer:function(t){if(t&&t.latLng){var e=i.ExSunMap.findLayer(this._oPosGroup,t.devNo);if(e)return this._oMap.hasLayer(e)||this._oMap.addLayer(e),void e.setLatLng(t.latLng);var n=this.getTruckCls(t),o=this._getIcon(n,i.Util.template(this.options.cHtml,t)),a=i.marker(t.latLng,{icon:o}).addTo(this._oPosGroup);a.oGpsInfo=t,a.cId=t.devNo,this.initEventForMarker(a)}},initEventForMarker:function(t){var e=this;if(t){var n={devNos:[t.oGpsInfo.devNo]};t.on("click",function(){var t=this;i.getData(JSON.stringify(n),e.options.url,function(n){var o=JSON.parse(n);if("0"===o.code){var a=o.detail;if(a&&!(a.length<=0)){a[0].trackBtn="跟踪";var s=i.ExSunMap.initPopHtml(a[0]);t.bindPopup(s,e.oPopOption);var r=t.getPopup();r.oGpsInfo=a[0],i.ExSunMap.initPopEven(r,e._oParent),e.initPopEven(r),t.openPopup()}}},e)})}},initPopEven:function(t){var n=this;t&&(t.self=this,t.on("contentupdate",function(){var t=e.getElementsByClassName("veh-detail")[0];i.DomEvent.on(t,"click",function(){},this),t=e.getElementsByClassName("veh-history")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("history",this.oGpsInfo)},this),t=e.getElementsByClassName("veh-track")[0],i.DomEvent.on(t,"click",function(){},this),t=e.getElementsByClassName("veh-attend")[0],i.DomEvent.on(t,"click",function(){},this),t=e.getElementsByClassName("veh-monitor")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("monitor",this.oGpsInfo)},this),t=e.getElementsByClassName("veh-send")[0],i.DomEvent.on(t,"click",function(){},this),t=e.getElementsByClassName("veh-video")[0],i.DomEvent.on(t,"click",function(){},this),t=e.getElementsByClassName("send-call-name")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("send-call-name",this.oGpsInfo)},this),t=e.getElementsByClassName("send-camera")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("send-camera",this.oGpsInfo)},this),t=e.getElementsByClassName("send-text")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("send-text",this.oGpsInfo)},this),t=e.getElementsByClassName("send-monitor")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("send-monitor",this.oGpsInfo)},this),t=e.getElementsByClassName("send-config")[0],i.DomEvent.on(t,"click",function(){n._oParent.$emit("send-config",this.oGpsInfo)},this)},t))},_getIcon:function(t,e){return i.divIcon({iconSize:[30,40],iconAnchor:[10,20],popupAnchor:[-1,-20],className:t,html:e})},getTruckCls:function(t){return"ex-monitor-mapicon-truck "+("1"==t.sta||"2"==t.sta?"green":"3"==t.sta?"green":"4"==t.sta?"yellow":"gray")}}),i.ExSunMap.LiveMange=i.Evented.extend({options:{nMonitorCnt:1},initialize:function(t,e,n){i.setOptions(this,e),this._oParent=t,this.map=n,this.initOn()},aoLivePos:[],initOn:function(){var t=this;this._oParent.$on("MapView:LiveMange.addLivePos",this.addLivePos,this),this._oParent.$on("MapView:LiveMange.addLive",this.addLive,this),this._oParent.$on("ws:gps",function(e){var n=e.aoGpsInfo;if(n&&!(n.length<=0))for(var o=0;o<n.length;o++){var a=n[o],s=i.ExSunMap.arrayIndex(this.aoLivePos,a,"devNo");if(s<0&&console.log("不用添加监视,不存在跟踪设备："+a.devNo+";车牌号"+a.vehNo),void 0===a.vehNo&&(a.vehNo=t.aoLivePos[0].options.vehNo),a.bOpenBubble=!0,!t.aoLivePos||t.aoLivePos.length<=0)return void console.log("没有跟踪对象！");t.aoLivePos[0].drawLiveTrack({oGpsInfo:a})}},this)},addLive:function(t){for(var e=t.oData,i=0;i<e.length;i++)this.addLivePos({oGpsInfo:e[i]})},removeLive:function(t){for(var e=t.acId,i=0;i<e.length;i++)this.removePos({oGpsInfo:{PhoneNum:e[i]}})},addLivePos:function(t){if(t&&t.oGpsInfo){var e=t.oGpsInfo;if(i.ExSunMap.arrayIndex(this.aoLivePos,t.oGpsInfo,"devNo")>=0)return void console.log("地图实时跟踪中存在已经跟踪的设备号"+e.devNo+";车牌号"+(e.devNo||"")+"！");if(this.aoLivePos.length>=this.options.nMonitorCnt){var n=this.aoLivePos.pop();this.removeMonitor(n)}var o=new i.ExSunMap.MapLive(this._oParent,t.oGpsInfo,this.map);this.aoLivePos.push(o),t.oGpsInfo.bOpenBubble=!0,o.drawLiveTrack(t)}},removeMonitor:function(t){t&&(t.offEven(),t.clearLiveTrack())},removePos:function(t){if(t&&t.oGpsInfo&&t.oGpsInfo.hasOwnProperty("devNo")){var e=i.ExSunMap.arrayIndex(this.aoLivePos,t.oGpsInfo,"devNo");if(-1!==e){var n=this.aoLivePos[e];n&&(this.removeMonitor(n),this.aoLivePos.splice(e,1))}}},removeAll:function(){if(this.aoLivePos&&!(this.aoLivePos.length<=0)){for(var t=[],e=0;e<this.aoLivePos.length;e++)this.aoLivePos[e].offEven(),this.aoLivePos[e].clearLiveTrack(),t.push(this.aoLivePos[e].options);this._oParent.$emit("HubSvr:batchUnsubGps",{aoGpsInfo:t}),this.aoLivePos.splice(0,this.aoLivePos.length)}}}),i.ExSunMap.MapLive=i.Evented.extend({initialize:function(t,e,n){this._oParent=t,i.setOptions(this,e),this.devNo=e.devNo||"-1",this.cId=null,this._oMap=n,this._loadLayerGroup(),this._initOn()},setOption:function(t){return t.hasOwnProperty("vehNo")&&delete t.vehNo,i.extend(this.options,t)},setFristGps:function(t){this.oFristGps=t},_initOn:function(){this._oMap.on("moveend",this._mapMoveHandler,this),this._oParent.$on("MV:Real.drawLiveTrack",this.drawLiveTrack,this),this._oParent.$on("MV:Real.showVecMarkerPop",this._showVecMarkerPop,this),this._oParent.$on("MV:Real.setLiveZoomIn",this.setLiveZoomIn,this),this._oParent.$on("MV:Real.clearLiveTrack",this.clearLiveTrack,this),this._oParent.$on("MapView:MapLive.setZoomIn",this.setZoomIn,this)},setZoomIn:function(t){if(t&&t.oGpsInfo){var e=t.oGpsInfo,n=i.ExSunMap.findLayer(this._oLivePosGroup,e.devNo);if(n){var o=n.getLatLng();this._oMap.flyTo(o,16),n.openPopup()}}},offEven:function(){this._oMap.off("moveend",this._mapMoveHandler,this),this._oParent.$off("ws:gps",this.drawLiveTrack,this),this._oParent.$off("MV:Real.unVisibleMarker"),this._oParent.$off("MV:Real.showVecMarkerPop",this._showVecMarkerPop,this),this._oParent.$off("MV:Real.setLiveZoomIn",this.setLiveZoomIn,this),this._oParent.$off("MV:Real.clearLiveTrack",this.clearLiveTrack,this)},_loadLayerGroup:function(){this._oLineGroup=i.featureGroup(),this._oMap.addLayer(this._oLineGroup),this._oTrackGroup=i.featureGroup(),this._oMap.addLayer(this._oTrackGroup),this._oLivePosGroup=i.featureGroup(),this._oMap.addLayer(this._oLivePosGroup)},_showVecMarkerPop:function(t){if(this._oLivePosGroup){var e=t.oGpsInfo;this._oLivePosGroup.eachLayer(function(t){if(e.devNo!=t.cId)return void t.closePopup();this._oMap.setView(t.getLatLng(),17),e.bOpenBubble?t.openPopup():t.closePopup()},this)}},_updateVecMarkerPop:function(t,e){t&&t.setPopupContent(e)},_drawLiveHis:function(){var t=this.oGpsInfo,e=null,n=i.ExSunMap.findLayer(this._oLineGroup,t.devNo),o=i.latLng(t.latLng.lat,t.latLng.lng);if(t.oLatLng=o,n)e=n.oPrePosInfo,n.oPrePosInfo=t,n.addLatLng(t.oLatLng);else{var a=i.polyline([t.oLatLng],i.ExSunMap.liveLineConfig);a.cId=t.devNo,a.oPrePosInfo=t,a.addTo(this._oLineGroup)}if(e){var s=i.circleMarker(e.oLatLng,i.ExSunMap.oLiveCircleMarkerConfig);s.addTo(this._oTrackGroup),s.oGpsInfo=t,this.initPopup(s),i.ExSunMap.initPopEven(s.getPopup(),this._oParent),t.bOpenBubble?s.openPopup():s.closePopup()}},_createLive:function(t){var e=t.latLng,n=i.Marker.movingMarker([e],[],{icon:this._getPosIconInfo(t,{nWidth:30,nHeight:40,nInitDir:180})});return n.cId=t.devNo,n.oData=t,n},_drawLive:function(){if(this._oLivePosGroup){var t=this.oGpsInfo,e=i.ExSunMap.findLayer(this._oLivePosGroup,t.devNo);if(e)e.moveTo(t.latLng,5e3),e.oCircle&&e.oCircle.setLatLng(t.latLng),e.oGpsInfo=t,this.initPopup(e);else{this.clearLiveTrackFrom(t),e=this._createLive(t),e.addTo(this._oLivePosGroup),e.oGpsInfo=t,this.initPopup(e),i.ExSunMap.initPopEven(e.getPopup(),this._oParent),t.bOpenBubble?e.openPopup():e.closePopup(),this.oLayer=e;var n=e.getLatLng();this._oMap.flyTo(n,16)}return this._setHeading(t,180),e._bringToFront(),e}},_mapMoveHandler:function(){this._oLivePosGroup&&this._oLivePosGroup.eachLayer(function(t){t._bringToFront&&t._bringToFront()},this)},clearLiveTrack:function(){this._oLivePosGroup.clearLayers(),this._oLineGroup.clearLayers(),this._oTrackGroup.clearLayers(),this._oParent.$emit("MapView:MapLive.addMarker",{oGpsInfo:this.options})},clearLiveTrackFrom:function(t){this._oLivePosGroup.clearLayers(),this._oLineGroup.clearLayers(),this._oTrackGroup.clearLayers(),this._oParent.$emit("MapView:ClusterLayer.removeLayer",{oGpsInfo:t})},drawLiveTrack:function(t){t.oGpsInfo.latLng&&(this.oGpsInfo=t.oGpsInfo,this._drawLiveHis(),this._drawLive())},setLiveZoomIn:function(){var t=this._oLivePosGroup.getLayers();if(t&&!(t.length<=0)&&t[0].getLatLng){var e=t[0].getLatLng(),i=this._oMap.getMaxZoom();this._oMap.setView(e,i-1)}}}),i.ExSunMap.MapLive.include({oPopOption:{maxWidth:500,autoPan:!1},_getPosIconInfo:function(t,e){return t.nDir=t.dir+e.nInitDir,new i.DivIcon({html:i.Util.template(this._getIconHtml(),t),className:this.getLeightOnCls(t),iconSize:i.point(30,40),iconAnchor:[10,20],popupAnchor:i.point(-1,-20)})},_getIconHtml:function(){return'<div cid="{devNo}" class="car-body" style="transform:rotateZ({nDir}deg);-webkit-transform: rotate({nDir}deg);"></div>    <div class="pin-tip " style="display: block;">        <div class="pin-dome"><b></b><c></c><d></d></div>        <div class="pin-number">{vehNo}</div>        <div class="pin-state">        </div></div>'},_setHeading:function(t,i){if(t){i||(i=0),t.nDir=t.dir+i;var n=e.querySelectorAll('[cId="'+t.devNo+'"]');!n||n.length<=0||(n[0].style.transform="rotate({"+t.nDir+"}deg)",n[0].style.webkitTransform="rotate({"+t.nDir+"}deg)")}},alarmToCls:function(t){var e={cAlarm:""};return t.cClsLight="green",t?(t.Speed>60&&(e.cAlarm="car-state speed"),e):e}}),i.ExSunMap.MapLive.include({initPopup:function(t){t.oGpsInfo.trackBtn="取消跟踪",t.oGpsInfo.attention?t.oGpsInfo.attentionBtn="取消关注":t.oGpsInfo.attentionBtn="关注";var e=i.ExSunMap.initPopHtml(t.oGpsInfo),n=t.getPopup();return n||(n=t.bindPopup(e,this.oPopOption).getPopup()),n.oGpsInfo=t.oGpsInfo,n.setContent(e),n},getLeightOnCls:function(t){var e="ex-monitor-mapicon-truck",i="gray";return 0==t.carType&&(e="ex-monitor-mapicon-tram"),1==t.sta||2==t.sta||3==t.sta?i="green":4==t.sta?i="yellow":5==t.sta&&(i="gray"),e+" "+i}}),i.WebSocketSvr=i.Class.extend({options:{url:"",nTimeOut:1e4,cSvrName:"GpsHub",aoClientName:[]},initialize:function(t,e){i.setOptions(this,e),this._oParent=t,this.afnCallBack=[],this.start(),this.initOn(),this.onReceive()},initSvr:function(){var t=null;try{t=new WebSocket(this.options.url)}catch(t){}if(!t)return void console.log("webSocket为空！");this.ws=t},start:function(){this.initSvr();try{this.ws.onopen=function(){console.log("webSocket已打开")}}catch(t){}},stop:function(){this.ws.close()},removeCallBack:function(t,e){if(this.afnCallBack&&!(this.afnCallBack.length<=0))for(var i=this.afnCallBack.length-1;i>=0;i--){var n=this.afnCallBack[i];n.fn===t&&n.PhoneNum===e.PhoneNum&&this.afnCallBack.splice(i,1)}},initOn:function(){this._oParent.$on("HubSvr.subGps",this.subGps,this)},subGps:function(t){t.type="0",t.status="1",console.log(JSON.stringify(t)),this.ws.send(JSON.stringify(t))},unsubGps:function(t){t.type="0",t.status="0",this.ws.send(JSON.stringify(t))},onReceive:function(){var t=this;this.ws.onmessage=function(e){var i=JSON.parse(e.data);!i.data||i.data.length<=0||t._oParent.$emit("ws:gps",{aoGpsInfo:i.data})}}}),i.ExSunMap.LocationLayer=i.Evented.extend({options:{url:"",onDrawLayers:"MapView:ClusterLayer.DrawLayers",onClearLayers:"MapView:ClusterLayer.clearLayer",onRemoveLayers:"MapView:ClusterLayer.removeLayers",cHtml:'<div cid="{devNo}" class="car-body" style="transform:rotate({dir}deg);-webkit-transform: rotate({dir}deg);"></div>    <div class="pin-tip " style="display: block;">        <div class="pin-dome">        </div>        <div class="pin-number">{vehNo}</div>        <div class="pin-state">        </div></div>'},oPopOption:{maxWidth:500,autoPan:!1},initialize:function(t,e,n){i.setOptions(this,e),this._oMap=n,this._oParent=t,this._initGroup(),this._loadOn()},_initGroup:function(){this._oPosGroup=i.featureGroup(),this._oMap.addLayer(this._oPosGroup)},_loadOn:function(){this._oParent.$on(this.options.onDrawLayers,this.drawLayers,this),this._oParent.$on(this.options.onClearLayers,this.clearLayer,this),this._oParent.$on(this.options.onRemoveLayers,this.removeLayers,this)},removeLayer:function(t){this._oPosGroup&&t&&t.oGpsInfo&&this._removeLayer(t.oGpsInfo)},removeLayers:function(t){if(this._oPosGroup&&t&&!(t.acId.length<=0))for(var e=t.acId,i=0;i<e.length;i++){var n=-parseInt(e[i]);this._removeLayer(n)}},_removeLayer:function(t){},clearLayer:function(){this._oPosGroup.clearLayers()},drawLayers:function(t){if(t&&t.aoData&&!(t.aoData.length<=0))for(var e=0;e<t.aoData.length;e++)this.drawLayer(t.aoData[e])},drawLayer:function(t){if(t&&t.latLng){var e=i.ExSunMap.findLayer(this._oPosGroup,t.devNo);if(e)return this._oMap.hasLayer(e)||this._oMap.addLayer(e),void e.setLatLng(t.latLng);var n=this.getTruckCls(t),o=this._getIcon(n,i.Util.template(this.options.cHtml,t)),a=i.marker(t.latLng,{icon:o}).addTo(this._oPosGroup);return a.oGpsInfo=t,a.cId=t.devNo,this.initEventForMarker(a),a}},initEventForMarker:function(t){var e=this;if(t){var n={devNos:[t.oGpsInfo.devNo]};t.on("click",function(){var t=this;i.getData(JSON.stringify(n),e.options.url,function(n){var o=JSON.parse(n);if("0"===o.code){var a=o.detail;if(a&&!(a.length<=0)){a[0].trackBtn="跟踪";var s=i.ExSunMap.initPopHtml(a[0]);t.bindPopup(s,e.oPopOption);var r=t.getPopup();r.oGpsInfo=a[0],i.ExSunMap.initPopEven(r,e._oParent),t.openPopup()}}},e)})}},initPopEven:function(t){var e=this;t&&(t.self=this,t.on("contentupdate",function(){i.ExSunMap.onEvent("veh-detail","click",function(){},this),i.ExSunMap.onEvent("veh-history","click",function(){e._oParent.$emit("history",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-track","click",function(){e._oParent.$emit("track",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-attend","click",function(){e._oParent.$emit("attend",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-monitor","click",function(){e._oParent.$emit("monitor",this.oGpsInfo)},this),i.ExSunMap.onEvent("veh-video","click",function(){e._oParent.$emit("video",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-call-name","click",function(){e._oParent.$emit("send-call-name",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-camera","click",function(){e._oParent.$emit("send-camera",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-text","click",function(){e._oParent.$emit("send-text",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-monitor","click",function(){e._oParent.$emit("send-monitor",this.oGpsInfo)},this),i.ExSunMap.onEvent("send-config","click",function(){e._oParent.$emit("send-config",this.oGpsInfo)},this)},t))},_getIcon:function(t,e){return i.divIcon({iconSize:[30,40],iconAnchor:[10,20],popupAnchor:[-1,-20],className:t,html:e})},getTruckCls:function(t){return"ex-monitor-mapicon-truck "+("1"==t.sta||"2"==t.sta?"green":"3"==t.sta?"green":"4"==t.sta?"yellow":"gray")}})}(window,document,L);